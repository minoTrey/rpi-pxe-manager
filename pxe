#!/usr/bin/env python3
"""
RPI PXE Manager - ì˜¬ì¸ì› ì‹¤í–‰ íŒŒì¼
ì„¤ì¹˜ë¶€í„° ì‹¤í–‰ê¹Œì§€ í•œ ë²ˆì—!
"""

import os
import sys
import subprocess
import json
import time
import threading
import re
from pathlib import Path
from datetime import datetime

# í•„ìš”í•œ íŒ¨í‚¤ì§€ ìë™ ì„¤ì¹˜
def install_packages():
    required = ['psutil', 'netifaces']
    missing = []
    
    for pkg in required:
        try:
            __import__(pkg)
        except ImportError:
            missing.append(pkg)
    
    if missing:
        print(f"ğŸ“¦ í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘: {', '.join(missing)}")
        cmd = [sys.executable, '-m', 'pip', 'install', '--user', '--break-system-packages'] + missing
        subprocess.run(cmd, stderr=subprocess.DEVNULL)
        print("âœ… íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ!")

install_packages()

import psutil
import netifaces
from typing import Dict, List, Optional, Tuple

# ANSI ìƒ‰ìƒ ì½”ë“œ
class Colors:
    HEADER = '\033[95m'
    BLUE = '\033[94m'
    CYAN = '\033[96m'
    GREEN = '\033[92m'
    YELLOW = '\033[93m'
    WARNING = '\033[93m'
    FAIL = '\033[91m'
    ENDC = '\033[0m'
    BOLD = '\033[1m'
    UNDERLINE = '\033[4m'
    CLEAR = '\033[2J\033[H'

class RPIPXEManager:
    def __init__(self):
        self.config_file = Path.home() / '.rpi_pxe_config.json'
        # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ì˜ í´ë¼ì´ì–¸íŠ¸ ë°±ì—… íŒŒì¼
        self.project_dir = Path(__file__).parent.resolve()
        self.clients_backup_file = self.project_dir / 'clients_backup.json'
        self.config = self.load_config()
        self.running = True
        
    def load_config(self) -> dict:
        """ì„¤ì • íŒŒì¼ ë¡œë“œ"""
        if self.config_file.exists():
            with open(self.config_file, 'r') as f:
                return json.load(f)
        return {
            'server_ip': '192.168.0.10',
            'dhcp_range_start': '192.168.0.100',
            'dhcp_range_end': '192.168.0.200',
            'network_interface': 'eth0',
            'nfs_root': '/media/polygom3d/rpi-client',
            'tftp_root': '/tftpboot',
            'clients': []
        }
    
    def save_config(self):
        """ì„¤ì • íŒŒì¼ ì €ì¥"""
        try:
            with open(self.config_file, 'w') as f:
                json.dump(self.config, f, indent=2)
            print(f"{Colors.GREEN}  âœ“ ì„¤ì • íŒŒì¼ ì €ì¥ë¨: {self.config_file} (í´ë¼ì´ì–¸íŠ¸ ìˆ˜: {len(self.config.get('clients', []))}ê°œ){Colors.ENDC}")

            # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ì— í´ë¼ì´ì–¸íŠ¸ ë°±ì—… ì €ì¥
            self.save_clients_backup()
        except Exception as e:
            print(f"{Colors.FAIL}  âœ— ì„¤ì • íŒŒì¼ ì €ì¥ ì‹¤íŒ¨: {e}{Colors.ENDC}")

    def save_clients_backup(self):
        """í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ì— í´ë¼ì´ì–¸íŠ¸ ë°±ì—… ì €ì¥"""
        try:
            backup_data = {
                'backup_date': datetime.now().strftime('%Y-%m-%d %H:%M:%S'),
                'server_ip': self.config.get('server_ip', ''),
                'nfs_root': self.config.get('nfs_root', ''),
                'clients': self.config.get('clients', [])
            }
            with open(self.clients_backup_file, 'w') as f:
                json.dump(backup_data, f, indent=2, ensure_ascii=False)
            print(f"{Colors.GREEN}  âœ“ í´ë¼ì´ì–¸íŠ¸ ë°±ì—… ì €ì¥ë¨: {self.clients_backup_file}{Colors.ENDC}")
        except Exception as e:
            print(f"{Colors.WARNING}  âš ï¸  í´ë¼ì´ì–¸íŠ¸ ë°±ì—… ì €ì¥ ì‹¤íŒ¨: {e}{Colors.ENDC}")

    def load_clients_backup(self) -> dict:
        """í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ì—ì„œ í´ë¼ì´ì–¸íŠ¸ ë°±ì—… ë¡œë“œ"""
        if self.clients_backup_file.exists():
            try:
                with open(self.clients_backup_file, 'r') as f:
                    return json.load(f)
            except Exception as e:
                print(f"{Colors.FAIL}  âœ— ë°±ì—… íŒŒì¼ ë¡œë“œ ì‹¤íŒ¨: {e}{Colors.ENDC}")
        return None

    def restore_clients_from_backup(self):
        """ë°±ì—…ì—ì„œ í´ë¼ì´ì–¸íŠ¸ ë³µì›"""
        self.print_header()
        print(f"{Colors.BOLD}ğŸ“¦ í´ë¼ì´ì–¸íŠ¸ ë°±ì—…/ë³µì›{Colors.ENDC}\n")

        backup = self.load_clients_backup()

        if backup:
            print(f"{Colors.CYAN}í˜„ì¬ ë°±ì—… ì •ë³´:{Colors.ENDC}")
            print(f"  ë°±ì—… ë‚ ì§œ: {backup.get('backup_date', 'ì•Œ ìˆ˜ ì—†ìŒ')}")
            print(f"  ì„œë²„ IP: {backup.get('server_ip', 'ì•Œ ìˆ˜ ì—†ìŒ')}")
            print(f"  NFS ê²½ë¡œ: {backup.get('nfs_root', 'ì•Œ ìˆ˜ ì—†ìŒ')}")
            print(f"  í´ë¼ì´ì–¸íŠ¸ ìˆ˜: {len(backup.get('clients', []))}ê°œ\n")

            if backup.get('clients'):
                print(f"{Colors.CYAN}ë°±ì—…ëœ í´ë¼ì´ì–¸íŠ¸ ëª©ë¡:{Colors.ENDC}")
                for i, client in enumerate(backup['clients'], 1):
                    print(f"  {i}. {client.get('hostname', 'unknown')} - {client.get('serial', 'N/A')} ({client.get('ip', 'N/A')})")
                print()
        else:
            print(f"{Colors.WARNING}ì €ì¥ëœ ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤.{Colors.ENDC}\n")

        print(f"{Colors.BOLD}ì˜µì…˜:{Colors.ENDC}")
        print(f"  {Colors.CYAN}1.{Colors.ENDC} í˜„ì¬ ì„¤ì •ì„ ë°±ì—…ìœ¼ë¡œ ì €ì¥")
        print(f"  {Colors.CYAN}2.{Colors.ENDC} ë°±ì—…ì—ì„œ í´ë¼ì´ì–¸íŠ¸ ë³µì›")
        print(f"  {Colors.CYAN}3.{Colors.ENDC} dnsmasq.confì—ì„œ í´ë¼ì´ì–¸íŠ¸ ê°€ì ¸ì˜¤ê¸°")
        print(f"  {Colors.CYAN}0.{Colors.ENDC} ëŒì•„ê°€ê¸°")
        print()

        choice = input("ì„ íƒ: ").strip()

        if choice == '1':
            self.save_clients_backup()
            print(f"\n{Colors.GREEN}âœ“ ë°±ì—… ì €ì¥ ì™„ë£Œ{Colors.ENDC}")

        elif choice == '2':
            if not backup or not backup.get('clients'):
                print(f"\n{Colors.FAIL}ë³µì›í•  ë°±ì—…ì´ ì—†ìŠµë‹ˆë‹¤.{Colors.ENDC}")
            else:
                confirm = input(f"\n{Colors.WARNING}í˜„ì¬ í´ë¼ì´ì–¸íŠ¸ ëª©ë¡ì„ ë°±ì—…ìœ¼ë¡œ ëŒ€ì²´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): {Colors.ENDC}").lower()
                if confirm == 'y':
                    self.config['clients'] = backup['clients']
                    self.save_config()
                    # dnsmasq ì„¤ì •ë„ ì¬ìƒì„±
                    self.generate_dnsmasq_config()
                    print(f"\n{Colors.GREEN}âœ“ í´ë¼ì´ì–¸íŠ¸ ë³µì› ì™„ë£Œ ({len(backup['clients'])}ê°œ){Colors.ENDC}")

        elif choice == '3':
            self.import_clients_from_dnsmasq()

        input("\nê³„ì†í•˜ë ¤ë©´ Enter...")

    def import_clients_from_dnsmasq(self):
        """dnsmasq.confì—ì„œ í´ë¼ì´ì–¸íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°"""
        dnsmasq_conf = Path('/etc/dnsmasq.conf')

        if not dnsmasq_conf.exists():
            print(f"{Colors.FAIL}/etc/dnsmasq.conf íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.{Colors.ENDC}")
            return

        try:
            with open(dnsmasq_conf, 'r') as f:
                content = f.read()

            import re
            clients = []
            # dhcp-host=MAC,IP,hostname í˜•ì‹ íŒŒì‹±
            pattern = r'dhcp-host=([0-9a-fA-F:]+),([0-9.]+),(\S+)'
            matches = re.findall(pattern, content)

            for mac, ip, hostname in matches:
                # ì‹œë¦¬ì–¼ ë²ˆí˜¸ ì¶”ì¶œ (hostnameì—ì„œ)
                serial = hostname.replace('rpi-', '') if hostname.startswith('rpi-') else hostname
                clients.append({
                    'serial': serial,
                    'mac': mac.lower(),
                    'ip': ip,
                    'hostname': hostname,
                    'boot_mode': 'nfs'
                })

            if clients:
                print(f"\n{Colors.CYAN}dnsmasq.confì—ì„œ ë°œê²¬ëœ í´ë¼ì´ì–¸íŠ¸:{Colors.ENDC}")
                for i, c in enumerate(clients, 1):
                    print(f"  {i}. {c['hostname']} - {c['serial']} ({c['ip']})")

                confirm = input(f"\n{Colors.YELLOW}ì´ í´ë¼ì´ì–¸íŠ¸ë“¤ì„ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): {Colors.ENDC}").lower()
                if confirm == 'y':
                    self.config['clients'] = clients
                    self.save_config()
                    print(f"\n{Colors.GREEN}âœ“ {len(clients)}ê°œ í´ë¼ì´ì–¸íŠ¸ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ{Colors.ENDC}")
            else:
                print(f"{Colors.WARNING}dnsmasq.confì—ì„œ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.{Colors.ENDC}")

        except Exception as e:
            print(f"{Colors.FAIL}dnsmasq.conf ì½ê¸° ì‹¤íŒ¨: {e}{Colors.ENDC}")
    
    def clear_screen(self):
        """í™”ë©´ ì§€ìš°ê¸°"""
        print(Colors.CLEAR, end='')
    
    def print_header(self):
        """í—¤ë” ì¶œë ¥"""
        self.clear_screen()
        print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.ENDC}")
        print(f"{Colors.BOLD}{Colors.GREEN}       RPI PXE Manager - í„°ë¯¸ë„ ê´€ë¦¬ ì‹œìŠ¤í…œ{Colors.ENDC}")
        print(f"{Colors.BOLD}{Colors.CYAN}{'='*60}{Colors.ENDC}")
        print()
    
    def print_menu(self):
        """ë©”ì¸ ë©”ë‰´ ì¶œë ¥"""
        print(f"{Colors.BOLD}ë©”ì¸ ë©”ë‰´:{Colors.ENDC}")
        print(f"  {Colors.CYAN}1.{Colors.ENDC} ğŸ“Š ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸")
        print(f"  {Colors.CYAN}2.{Colors.ENDC} ğŸ–¥ï¸  í´ë¼ì´ì–¸íŠ¸ ê´€ë¦¬")
        print(f"  {Colors.CYAN}3.{Colors.ENDC} âš™ï¸  ì„œë²„ ì„¤ì •")
        print(f"  {Colors.CYAN}4.{Colors.ENDC} ğŸš€ ì„œë¹„ìŠ¤ ê´€ë¦¬")
        print(f"  {Colors.CYAN}5.{Colors.ENDC} ğŸ“ ë¡œê·¸ í™•ì¸")
        print(f"  {Colors.CYAN}6.{Colors.ENDC} ğŸ”§ ì´ˆê¸° ì„¤ì • ë§ˆë²•ì‚¬")
        print(f"  {Colors.CYAN}0.{Colors.ENDC} ğŸšª ì¢…ë£Œ")
        print()
    
    def get_system_status(self) -> Dict:
        """ì‹œìŠ¤í…œ ìƒíƒœ ì •ë³´ ìˆ˜ì§‘"""
        status = {
            'cpu': psutil.cpu_percent(interval=1),
            'memory': psutil.virtual_memory().percent,
            'disk': psutil.disk_usage('/').percent,
            'network': {},
            'services': {}
        }
        
        # ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì •ë³´
        try:
            iface = self.config['network_interface']
            addrs = netifaces.ifaddresses(iface)
            if netifaces.AF_INET in addrs:
                status['network']['ip'] = addrs[netifaces.AF_INET][0]['addr']
                status['network']['netmask'] = addrs[netifaces.AF_INET][0]['netmask']
        except:
            status['network']['ip'] = 'N/A'
            status['network']['netmask'] = 'N/A'
        
        # ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
        services = ['dnsmasq', 'nfs-kernel-server', 'tftpd-hpa']
        for service in services:
            result = subprocess.run(['systemctl', 'is-active', service], 
                                  capture_output=True, text=True)
            status['services'][service] = result.stdout.strip() == 'active'
        
        return status
    
    def show_system_status(self):
        """ì‹œìŠ¤í…œ ìƒíƒœ í‘œì‹œ"""
        self.print_header()
        print(f"{Colors.BOLD}ì‹œìŠ¤í…œ ìƒíƒœ{Colors.ENDC}\n")
        
        status = self.get_system_status()
        
        # ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ë¥ 
        print(f"{Colors.BOLD}ë¦¬ì†ŒìŠ¤ ì‚¬ìš©ë¥ :{Colors.ENDC}")
        self.print_progress_bar("CPU", status['cpu'])
        self.print_progress_bar("ë©”ëª¨ë¦¬", status['memory'])
        self.print_progress_bar("ë””ìŠ¤í¬", status['disk'])
        print()
        
        # ë„¤íŠ¸ì›Œí¬ ì •ë³´
        print(f"{Colors.BOLD}ë„¤íŠ¸ì›Œí¬ ì„¤ì •:{Colors.ENDC}")
        print(f"  ì¸í„°í˜ì´ìŠ¤: {self.config['network_interface']}")
        print(f"  IP ì£¼ì†Œ: {status['network'].get('ip', 'N/A')}")
        print(f"  ë„·ë§ˆìŠ¤í¬: {status['network'].get('netmask', 'N/A')}")
        print()
        
        # ì„œë¹„ìŠ¤ ìƒíƒœ
        print(f"{Colors.BOLD}ì„œë¹„ìŠ¤ ìƒíƒœ:{Colors.ENDC}")
        for service, active in status['services'].items():
            icon = "âœ…" if active else "âŒ"
            color = Colors.GREEN if active else Colors.FAIL
            print(f"  {icon} {color}{service:<20}{Colors.ENDC} {'ì‹¤í–‰ ì¤‘' if active else 'ì¤‘ì§€ë¨'}")
        
        print()
        input(f"{Colors.CYAN}Enterë¥¼ ëˆŒëŸ¬ ê³„ì†...{Colors.ENDC}")
    
    def ip_to_number(self, ip_str):
        """IP ì£¼ì†Œë¥¼ ìˆ«ìë¡œ ë³€í™˜í•˜ì—¬ ì •ë ¬"""
        if ip_str == 'N/A' or not ip_str or ip_str == 'ì—†ìŒ':
            return 999999999
        try:
            parts = ip_str.split('.')
            return int(parts[0]) * 256**3 + int(parts[1]) * 256**2 + int(parts[2]) * 256 + int(parts[3])
        except:
            return 999999999
    
    def print_progress_bar(self, label: str, percent: float, width: int = 30):
        """í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì¶œë ¥"""
        filled = int(width * percent / 100)
        bar = 'â–ˆ' * filled + 'â–‘' * (width - filled)
        
        if percent < 50:
            color = Colors.GREEN
        elif percent < 80:
            color = Colors.WARNING
        else:
            color = Colors.FAIL
        
        print(f"  {label:8} [{color}{bar}{Colors.ENDC}] {percent:5.1f}%")
    
    def check_client_status(self, ip: str) -> bool:
        """í´ë¼ì´ì–¸íŠ¸ ì˜¨ë¼ì¸ ìƒíƒœ í™•ì¸"""
        try:
            # pingìœ¼ë¡œ í™•ì¸ (1íšŒ, 1ì´ˆ íƒ€ì„ì•„ì›ƒ)
            result = subprocess.run(
                ['ping', '-c', '1', '-W', '1', ip],
                capture_output=True,
                text=True,
                timeout=2
            )
            return result.returncode == 0
        except Exception:
            return False
    
    def manage_clients(self):
        """í´ë¼ì´ì–¸íŠ¸ ê´€ë¦¬ ë©”ë‰´"""
        while True:
            self.print_header()
            print(f"{Colors.BOLD}í´ë¼ì´ì–¸íŠ¸ ê´€ë¦¬{Colors.ENDC}\n")
            
            # IP ì£¼ì†Œë¡œ í´ë¼ì´ì–¸íŠ¸ ì •ë ¬
            sorted_clients = sorted(self.config['clients'], key=lambda c: self.ip_to_number(c.get('ip', 'N/A')))
            
            # í´ë¼ì´ì–¸íŠ¸ ëª©ë¡ í‘œì‹œ
            if sorted_clients:
                print(f"{Colors.BOLD}ë“±ë¡ëœ í´ë¼ì´ì–¸íŠ¸:{Colors.ENDC}")
                print(f"  {'ë²ˆí˜¸':<4} {'ì‹œë¦¬ì–¼/í˜¸ìŠ¤íŠ¸ëª…':<15} {'IP ì£¼ì†Œ':<15} {'MAC ì£¼ì†Œ':<20}")
                print(f"  {'-'*65}")
                for i, client in enumerate(sorted_clients, 1):
                    # í˜¸ìŠ¤íŠ¸ëª…ì´ ì‹œë¦¬ì–¼ê³¼ ê°™ìœ¼ë¯€ë¡œ ì‹œë¦¬ì–¼ë§Œ í‘œì‹œ
                    serial = client['serial']
                    ip = client.get('ip', 'N/A')
                    mac = client.get('mac', 'N/A')
                    print(f"  {i:<4} {serial:<15} {ip:<15} {mac:<20}")
                print()
            else:
                print(f"{Colors.WARNING}ë“±ë¡ëœ í´ë¼ì´ì–¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.{Colors.ENDC}\n")
            
            print(f"{Colors.BOLD}ì˜µì…˜:{Colors.ENDC}")
            print(f"  {Colors.CYAN}1.{Colors.ENDC} ìƒˆ í´ë¼ì´ì–¸íŠ¸ ì¶”ê°€")
            print(f"  {Colors.CYAN}2.{Colors.ENDC} í´ë¼ì´ì–¸íŠ¸ ì œê±°")
            print(f"  {Colors.CYAN}3.{Colors.ENDC} í´ë¼ì´ì–¸íŠ¸ ì •ë³´ í¸ì§‘")
            print(f"  {Colors.CYAN}4.{Colors.ENDC} SD ì¹´ë“œì—ì„œ ì‹œìŠ¤í…œ ë³µì‚¬")
            print(f"  {Colors.CYAN}5.{Colors.ENDC} ğŸ“¦ í´ë¼ì´ì–¸íŠ¸ ë°±ì—…/ë³µì›")
            print(f"  {Colors.CYAN}R.{Colors.ENDC} ìƒíƒœ ìƒˆë¡œê³ ì¹¨")
            print(f"  {Colors.CYAN}0.{Colors.ENDC} ë’¤ë¡œ ê°€ê¸°")
            print()

            choice = input(f"{Colors.CYAN}ì„ íƒ: {Colors.ENDC}").strip().upper()

            if choice == '1':
                self.add_client()
            elif choice == '2':
                self.remove_client()
            elif choice == '3':
                self.edit_client()
            elif choice == '4':
                self.copy_from_sd()
            elif choice == '5':
                self.restore_clients_from_backup()
            elif choice == 'R':
                print(f"{Colors.CYAN}ìƒíƒœë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤...{Colors.ENDC}")
                continue  # ë£¨í”„ ë‹¤ì‹œ ì‹œì‘í•˜ì—¬ ìƒíƒœ ì—…ë°ì´íŠ¸
            elif choice == '0':
                break
    
    def add_client(self):
        """ìƒˆ í´ë¼ì´ì–¸íŠ¸ ì¶”ê°€ (MAC ì£¼ì†Œ ìë™ ì™„ì„± ì§€ì›)"""
        self.print_header()
        print(f"{Colors.BOLD}ìƒˆ í´ë¼ì´ì–¸íŠ¸ ì¶”ê°€{Colors.ENDC}\n")
        
        # ê¸°ì¡´ IP ì£¼ì†Œì—ì„œ ë¹ˆ ë²ˆí˜¸ ì°¾ê¸°
        network_prefix = ".".join(self.config['server_ip'].split('.')[:3])
        used_ip_numbers = []
        for client in self.config['clients']:
            if client.get('ip', '').startswith(network_prefix):
                try:
                    ip_num = int(client['ip'].split('.')[-1])
                    used_ip_numbers.append(ip_num)
                except:
                    pass
        
        # ë¹ˆ ë²ˆí˜¸ ì°¾ê¸° (100ë¶€í„° ì‹œì‘)
        suggested_ip = f"{network_prefix}.100"  # ê¸°ë³¸ê°’
        if used_ip_numbers:
            used_ip_numbers.sort()
            # 100ë¶€í„° ì‹œì‘í•´ì„œ ë¹ˆ ë²ˆí˜¸ ì°¾ê¸°
            for num in range(100, max(used_ip_numbers) + 2):
                if num not in used_ip_numbers:
                    suggested_ip = f"{network_prefix}.{num}"
                    break
            
            # í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ IP í‘œì‹œ
            print(f"{Colors.CYAN}â€» í˜„ì¬ ì‚¬ìš© ì¤‘: {', '.join([f'.{n}' for n in used_ip_numbers[:10]])}{Colors.ENDC}")
            if len(used_ip_numbers) > 10:
                print(f"{Colors.CYAN}              ì™¸ {len(used_ip_numbers) - 10}ê°œ{Colors.ENDC}")
        
        print(f"{Colors.CYAN}â€» ê¶Œì¥: IPëŠ” 192.168.0.100ë¶€í„° ìˆœì„œëŒ€ë¡œ í• ë‹¹{Colors.ENDC}")
        
        print(f"{Colors.CYAN}ë¼ì¦ˆë² ë¦¬íŒŒì´ ì •ë³´ ì…ë ¥{Colors.ENDC}")
        print(f"{Colors.WARNING}íŒ: ëª¨ë“  ë¼ì¦ˆë² ë¦¬íŒŒì´ MAC ì£¼ì†ŒëŠ” 88:a2:9e:1b:ë¡œ ì‹œì‘í•©ë‹ˆë‹¤{Colors.ENDC}")
        print(f"{Colors.WARNING}    ë§ˆì§€ë§‰ 4ìë¦¬ë§Œ ì…ë ¥í•˜ë©´ ìë™ ì™„ì„±ë©ë‹ˆë‹¤ (ì˜ˆ: e3:0f){Colors.ENDC}\n")
        
        # ì‹œë¦¬ì–¼ ë²ˆí˜¸ ì…ë ¥ (í˜¸ìŠ¤íŠ¸ëª…ìœ¼ë¡œë„ ì‚¬ìš©)
        serial = input(f"ì‹œë¦¬ì–¼ ë²ˆí˜¸ (8ìë¦¬ 16ì§„ìˆ˜): ").strip().lower()
        if not serial:
            print(f"{Colors.FAIL}ì‹œë¦¬ì–¼ ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤{Colors.ENDC}")
            time.sleep(2)
            return
        
        # MAC ì£¼ì†Œ ì…ë ¥ (ì§§ì€ í˜•ì‹ ì§€ì›)
        mac_input = input(f"MAC ì£¼ì†Œ (ì „ì²´ ë˜ëŠ” ë§ˆì§€ë§‰ 4ìë¦¬): ").strip().lower()
        if not mac_input:
            print(f"{Colors.FAIL}MAC ì£¼ì†ŒëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤{Colors.ENDC}")
            time.sleep(2)
            return
        
        # MAC ì£¼ì†Œ ìë™ ì™„ì„±
        if len(mac_input) == 5 and ':' in mac_input:  # e3:0f í˜•ì‹
            mac = f"88:a2:9e:1b:{mac_input}"
            print(f"  â†’ ìë™ ì™„ì„±: {mac}")
        elif len(mac_input) == 4:  # e30f í˜•ì‹
            mac = f"88:a2:9e:1b:{mac_input[:2]}:{mac_input[2:]}"
            print(f"  â†’ ìë™ ì™„ì„±: {mac}")
        else:
            mac = mac_input
        
        # MAC ì£¼ì†Œ ìœ íš¨ì„± ê²€ì‚¬
        if not re.match(r'^([0-9a-f]{2}:){5}[0-9a-f]{2}$', mac):
            print(f"{Colors.FAIL}ì˜¬ë°”ë¥¸ MAC ì£¼ì†Œ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤{Colors.ENDC}")
            time.sleep(2)
            return
        
        # IP ì£¼ì†Œ ì…ë ¥
        ip_input = input(f"ê³ ì • IP ì£¼ì†Œ [{suggested_ip}]: ").strip()
        ip = ip_input if ip_input else suggested_ip
        
        # ì¤‘ë³µ í™•ì¸
        for client in self.config['clients']:
            if client['serial'] == serial:
                print(f"{Colors.FAIL}ì´ë¯¸ ë“±ë¡ëœ ì‹œë¦¬ì–¼ ë²ˆí˜¸ì…ë‹ˆë‹¤{Colors.ENDC}")
                time.sleep(2)
                return
            if client.get('mac') == mac:
                print(f"{Colors.FAIL}ì´ë¯¸ ë“±ë¡ëœ MAC ì£¼ì†Œì…ë‹ˆë‹¤{Colors.ENDC}")
                time.sleep(2)
                return
        
        # í´ë¼ì´ì–¸íŠ¸ ì¶”ê°€
        new_client = {
            'serial': serial,
            'hostname': serial,  # ì‹œë¦¬ì–¼ì„ í˜¸ìŠ¤íŠ¸ëª…ìœ¼ë¡œ ì‚¬ìš©
            'mac': mac,
            'ip': ip,
            'online': False
        }
        
        self.config['clients'].append(new_client)
        self.save_config()
        
        print(f"\n{Colors.GREEN}âœ“ í´ë¼ì´ì–¸íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤{Colors.ENDC}")
        print(f"  ì‹œë¦¬ì–¼/í˜¸ìŠ¤íŠ¸ëª…: {serial}")
        print(f"  MAC ì£¼ì†Œ: {mac}")
        print(f"  IP ì£¼ì†Œ: {ip}")
        
        # PXE ë¶€íŒ… ì„¤ì • ìƒì„±
        self.create_client_directories(serial, mac, ip, serial)
        
        # ê¸°ì¡´ í´ë¼ì´ì–¸íŠ¸ê°€ ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ ì‹œìŠ¤í…œ ë³µì‚¬
        existing_clients = [c for c in self.config['clients'] if c['serial'] != serial]
        if existing_clients:
            # NFS ë£¨íŠ¸ê°€ ìˆëŠ” í´ë¼ì´ì–¸íŠ¸ ì°¾ê¸°
            for client in existing_clients:
                nfs_path = Path(self.config['nfs_root']) / client['serial']
                if nfs_path.exists() and (nfs_path / 'etc').exists():
                    print(f"\n{Colors.CYAN}ê¸°ì¡´ í´ë¼ì´ì–¸íŠ¸({client['serial']})ì—ì„œ ì‹œìŠ¤í…œì„ ìë™ ë³µì‚¬í•©ë‹ˆë‹¤...{Colors.ENDC}")
                    self.copy_system_from_existing(client['serial'], serial, mac, ip, serial)
                    break
            else:
                print(f"\n{Colors.YELLOW}ì‹œìŠ¤í…œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— SD ì¹´ë“œë‚˜ í…œí”Œë¦¿ì—ì„œ ë³µì‚¬í•˜ì„¸ìš”.{Colors.ENDC}")
        else:
            print(f"\n{Colors.YELLOW}ì²« ë²ˆì§¸ í´ë¼ì´ì–¸íŠ¸ì…ë‹ˆë‹¤. SD ì¹´ë“œì—ì„œ ì‹œìŠ¤í…œì„ ë³µì‚¬í•˜ì„¸ìš”.{Colors.ENDC}")
    
    def setup_ssh_for_client(self, target_nfs: Path, hostname: str):
        """SSH ì„œë¹„ìŠ¤ ì„¤ì • ë° í‚¤ ì¬ìƒì„±"""
        try:
            print(f"  SSH ì„¤ì • ì¤‘...")
            
            # SSH ë””ë ‰í† ë¦¬ í™•ì¸
            ssh_dir = target_nfs / 'etc' / 'ssh'
            if not ssh_dir.exists():
                subprocess.run(['sudo', 'mkdir', '-p', str(ssh_dir)], check=True)
            
            # ê¸°ì¡´ SSH í˜¸ìŠ¤íŠ¸ í‚¤ ì‚­ì œ (ìƒˆë¡œìš´ í‚¤ ìƒì„±ì„ ìœ„í•´)
            print(f"    - ê¸°ì¡´ SSH í˜¸ìŠ¤íŠ¸ í‚¤ ì‚­ì œ...")
            subprocess.run(['sudo', 'rm', '-f', str(ssh_dir / 'ssh_host_*')], shell=True, stderr=subprocess.DEVNULL)
            
            # ìƒˆë¡œìš´ SSH í˜¸ìŠ¤íŠ¸ í‚¤ ìƒì„±
            print(f"    - ìƒˆ SSH í˜¸ìŠ¤íŠ¸ í‚¤ ìƒì„±...")
            for key_type in ['rsa', 'ecdsa', 'ed25519']:
                key_path = ssh_dir / f'ssh_host_{key_type}_key'
                # -q: quiet, -N '': no passphrase, -f: output file
                # íŒŒì¼ì´ ì¡´ì¬í•˜ë©´ ë¨¼ì € ì‚­ì œ
                subprocess.run(['sudo', 'rm', '-f', str(key_path), str(key_path) + '.pub'], stderr=subprocess.DEVNULL)
                subprocess.run(['sudo', 'ssh-keygen', '-t', key_type, '-f', str(key_path), '-N', '', '-q'], check=True)
            
            # SSH í‚¤ íŒŒì¼ ê¶Œí•œ ì„¤ì • (ì¤‘ìš”: SSHëŠ” ì—„ê²©í•œ ê¶Œí•œì„ ìš”êµ¬í•¨)
            print(f"    - SSH í‚¤ ê¶Œí•œ ì„¤ì •...")
            # SSH ë””ë ‰í† ë¦¬ ê¶Œí•œ
            subprocess.run(['sudo', 'chmod', '755', str(ssh_dir)], check=True)
            # ê°œì¸ í‚¤ëŠ” 600 (ì†Œìœ ìë§Œ ì½ê¸°/ì“°ê¸°)
            for key_file in ssh_dir.glob('ssh_host_*_key'):
                if not str(key_file).endswith('.pub'):
                    subprocess.run(['sudo', 'chmod', '600', str(key_file)], check=True)
            # ê³µê°œ í‚¤ëŠ” 644 (ì†Œìœ ì ì½ê¸°/ì“°ê¸°, ë‚˜ë¨¸ì§€ ì½ê¸°ë§Œ)
            for pub_file in ssh_dir.glob('ssh_host_*.pub'):
                subprocess.run(['sudo', 'chmod', '644', str(pub_file)], check=True)
            
            # SSH ì„¤ì • íŒŒì¼ ìˆ˜ì • (ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ í—ˆìš©)
            sshd_config = ssh_dir / 'sshd_config'
            if sshd_config.exists():
                print(f"    - SSH ì„¤ì • íŒŒì¼ ìˆ˜ì •...")
                subprocess.run(['sudo', 'sed', '-i', 's/^#PasswordAuthentication.*/PasswordAuthentication yes/', str(sshd_config)], check=True)
                subprocess.run(['sudo', 'sed', '-i', 's/^PasswordAuthentication no/PasswordAuthentication yes/', str(sshd_config)], check=True)
                subprocess.run(['sudo', 'sed', '-i', 's/^#PermitRootLogin.*/PermitRootLogin yes/', str(sshd_config)], check=True)
                subprocess.run(['sudo', 'sed', '-i', 's/^PermitRootLogin prohibit-password/PermitRootLogin yes/', str(sshd_config)], check=True)
                # sshd_config ê¶Œí•œ ì„¤ì • (644: ì†Œìœ ì ì½ê¸°/ì“°ê¸°, ë‚˜ë¨¸ì§€ ì½ê¸°ë§Œ)
                subprocess.run(['sudo', 'chmod', '644', str(sshd_config)], check=True)
            
            # SSH ì„œë¹„ìŠ¤ ìë™ í™œì„±í™”
            print(f"    - SSH ì„œë¹„ìŠ¤ í™œì„±í™”...")
            ssh_service_link = target_nfs / 'etc' / 'systemd' / 'system' / 'multi-user.target.wants' / 'ssh.service'
            if not ssh_service_link.exists():
                subprocess.run(['sudo', 'mkdir', '-p', str(ssh_service_link.parent)], check=True)
                subprocess.run(['sudo', 'ln', '-sf', '/lib/systemd/system/ssh.service', str(ssh_service_link)], check=True)
            
            # sshd ì„œë¹„ìŠ¤ë„ í™œì„±í™” (ì¼ë¶€ ì‹œìŠ¤í…œì—ì„œëŠ” sshd.service ì‚¬ìš©)
            sshd_service_link = target_nfs / 'etc' / 'systemd' / 'system' / 'multi-user.target.wants' / 'sshd.service'
            if not sshd_service_link.exists():
                ssh_service_file = target_nfs / 'lib' / 'systemd' / 'system' / 'sshd.service'
                if ssh_service_file.exists():
                    subprocess.run(['sudo', 'ln', '-sf', '/lib/systemd/system/sshd.service', str(sshd_service_link)], check=True)
            
            print(f"    - SSH ì„¤ì • ì™„ë£Œ")
            return True
            
        except Exception as e:
            print(f"{Colors.WARNING}    - SSH ì„¤ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}{Colors.ENDC}")
            return False
    
    def copy_system_from_existing(self, source_serial: str, target_serial: str, mac: str, ip: str, hostname: str):
        """ê¸°ì¡´ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì‹œìŠ¤í…œ ìë™ ë³µì‚¬"""
        source_nfs = Path(self.config['nfs_root']) / source_serial
        source_tftp = Path(self.config['tftp_root']) / source_serial
        target_nfs = Path(self.config['nfs_root']) / target_serial
        target_tftp = Path(self.config['tftp_root']) / target_serial
        
        try:
            # TFTP boot íŒŒì¼ ë³µì‚¬
            if source_tftp.exists():
                print(f"  Boot íŒŒì¼ ë³µì‚¬ ì¤‘...")
                subprocess.run(['sudo', 'cp', '-a', str(source_tftp) + '/.', str(target_tftp)], check=True)
                
                # cmdline.txt ìˆ˜ì • - ë§¤ê°œë³€ìˆ˜ë¡œ ë°›ì€ IPì™€ hostname ì‚¬ìš©
                cmdline_path = target_tftp / 'cmdline.txt'
                if cmdline_path.exists():
                    # ë§¤ê°œë³€ìˆ˜ë¡œ ë°›ì€ ì •ë³´ ì‚¬ìš© (ìƒˆ í´ë¼ì´ì–¸íŠ¸ëŠ” ì•„ì§ configì— ì—†ìŒ)
                    if ip:
                        # ë„¤íŠ¸ì›Œí¬ ì„¤ì •
                        network_base = '.'.join(self.config['server_ip'].split('.')[:3])
                        gateway = f"{network_base}.1"
                        netmask = "255.255.255.0"
                        # ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ìë™ ê°ì§€ (ì˜ˆì¸¡ ê°€ëŠ¥í•œ ì´ë¦„ ë˜ëŠ” eth0)
                        # ìµœì‹  Raspberry Pi OSëŠ” ì˜ˆì¸¡ ê°€ëŠ¥í•œ ë„¤íŠ¸ì›Œí¬ ì´ë¦„ ì‚¬ìš© (ì˜ˆ: end0, enxb827eb123456)
                        iface = ":"  # ë¹ˆ ê°’ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ì»¤ë„ì´ ìë™ ê°ì§€
                        # ê³ ì • IP í˜•ì‹
                        cmdline = f"console=serial0,115200 console=tty1 root=/dev/nfs nfsroot={self.config['server_ip']}:{target_nfs},vers=3 rw ip={ip}:{self.config['server_ip']}:{gateway}:{netmask}:{hostname}:{iface}:off rootwait elevator=deadline"
                    else:
                        # IPê°€ ì—†ìœ¼ë©´ DHCP ì‚¬ìš© (fallback)
                        cmdline = f"console=serial0,115200 console=tty1 root=/dev/nfs nfsroot={self.config['server_ip']}:{target_nfs},vers=3 rw ip=dhcp rootwait"
                    subprocess.run(['sudo', 'tee', str(cmdline_path)], 
                                 input=cmdline.encode(), 
                                 stdout=subprocess.DEVNULL, check=True)
            
            # NFS root íŒŒì¼ì‹œìŠ¤í…œ ë³µì‚¬
            if source_nfs.exists():
                print(f"  Root íŒŒì¼ì‹œìŠ¤í…œ ë³µì‚¬ ì¤‘...")
                subprocess.run([
                    'sudo', 'rsync', '-aHAXx', '--info=progress2',
                    '--exclude=captures', '--exclude=videos', '--exclude=*.log',
                    str(source_nfs) + '/', str(target_nfs) + '/'
                ], check=True)
                
                # fstab ìµœì†Œí™”
                fstab_path = target_nfs / 'etc' / 'fstab'
                if fstab_path.exists():
                    minimal_fstab = """proc            /proc           proc    defaults          0       0
tmpfs           /tmp            tmpfs   defaults,nosuid   0       0
devpts          /dev/pts        devpts  gid=5,mode=620    0       0
"""
                    subprocess.run(['sudo', 'tee', str(fstab_path)], 
                                 input=minimal_fstab.encode(), 
                                 stdout=subprocess.DEVNULL, check=True)
                
                # hostname ì„¤ì •
                hostname_path = target_nfs / 'etc' / 'hostname'
                if hostname_path.exists():
                    subprocess.run(['sudo', 'tee', str(hostname_path)], 
                                 input=hostname.encode(), 
                                 stdout=subprocess.DEVNULL, check=True)
                
                # sudo ê¶Œí•œ ìˆ˜ì • (NFS ë¶€íŒ… ì‹œ í•„ìš”)
                print(f"  sudo ê¶Œí•œ ì„¤ì • ì¤‘...")
                
                # sudo ë°”ì´ë„ˆë¦¬ ê¶Œí•œ ìˆ˜ì •
                sudo_bin_path = target_nfs / 'usr' / 'bin' / 'sudo'
                if sudo_bin_path.exists():
                    subprocess.run(['sudo', 'chown', 'root:root', str(sudo_bin_path)], check=True)
                    subprocess.run(['sudo', 'chmod', '4755', str(sudo_bin_path)], check=True)
                
                # sudo.conf ê¶Œí•œ ìˆ˜ì •
                sudo_conf_path = target_nfs / 'etc' / 'sudo.conf'
                if sudo_conf_path.exists():
                    subprocess.run(['sudo', 'chown', 'root:root', str(sudo_conf_path)], check=True)
                    subprocess.run(['sudo', 'chmod', '644', str(sudo_conf_path)], check=True)
                
                # sudo í”ŒëŸ¬ê·¸ì¸ ë””ë ‰í† ë¦¬ ê¶Œí•œ ìˆ˜ì •
                sudo_lib_path = target_nfs / 'usr' / 'lib' / 'sudo'
                if sudo_lib_path.exists():
                    subprocess.run(['sudo', 'chown', '-R', 'root:root', str(sudo_lib_path)], check=True)
                    subprocess.run(['sudo', 'chmod', '755', str(sudo_lib_path)], check=True)
                    
                    # sudoers.so ì‹¤í–‰ ê¶Œí•œ
                    sudoers_so = sudo_lib_path / 'sudoers.so'
                    if sudoers_so.exists():
                        subprocess.run(['sudo', 'chmod', '755', str(sudoers_so)], check=True)
                    
                    # libsudo_util.so* íŒŒì¼ë“¤ ì‹¤í–‰ ê¶Œí•œ
                    for lib_file in sudo_lib_path.glob('libsudo_util.so*'):
                        subprocess.run(['sudo', 'chmod', '755', str(lib_file)], check=True)
                    
                    # ë‚˜ë¨¸ì§€ .so íŒŒì¼ë“¤
                    for so_file in sudo_lib_path.glob('*.so'):
                        if so_file.name not in ['sudoers.so'] and not so_file.name.startswith('libsudo_util'):
                            subprocess.run(['sudo', 'chmod', '644', str(so_file)], check=True)
                
                # /etc/sudoers íŒŒì¼ ê¶Œí•œ
                sudoers_path = target_nfs / 'etc' / 'sudoers'
                if sudoers_path.exists():
                    subprocess.run(['sudo', 'chown', 'root:root', str(sudoers_path)], check=True)
                    subprocess.run(['sudo', 'chmod', '440', str(sudoers_path)], check=True)
                
                # /etc/sudoers.d ë””ë ‰í† ë¦¬ ê¶Œí•œ
                sudoers_d_path = target_nfs / 'etc' / 'sudoers.d'
                if sudoers_d_path.exists():
                    subprocess.run(['sudo', 'chown', 'root:root', str(sudoers_d_path)], check=True)
                    subprocess.run(['sudo', 'chmod', '755', str(sudoers_d_path)], check=True)
                    # sudoers.d ë‚´ë¶€ íŒŒì¼ë“¤
                    for sudoers_file in sudoers_d_path.glob('*'):
                        if sudoers_file.is_file():
                            subprocess.run(['sudo', 'chown', 'root:root', str(sudoers_file)], check=True)
                            subprocess.run(['sudo', 'chmod', '440', str(sudoers_file)], check=True)
                
                # SSH ì„¤ì • ë° í‚¤ ì¬ìƒì„±
                self.setup_ssh_for_client(target_nfs, hostname)
                
                # hosts íŒŒì¼ ìˆ˜ì •
                hosts_path = target_nfs / 'etc' / 'hosts'
                if hosts_path.exists():
                    # raspberrypiì™€ ê¸°ì¡´ í˜¸ìŠ¤íŠ¸ëª…ì„ ìƒˆ í˜¸ìŠ¤íŠ¸ëª…ìœ¼ë¡œ ë³€ê²½
                    subprocess.run([
                        'sudo', 'sed', '-i',
                        f's/\\braspberrypi\\b/{hostname}/g',
                        str(hosts_path)
                    ], check=True)
                    subprocess.run([
                        'sudo', 'sed', '-i',
                        f's/\\b{source_serial}\\b/{hostname}/g',
                        str(hosts_path)
                    ], check=True)
                    
                    # 127.0.1.1 ë¼ì¸ ì¬ì„¤ì •
                    subprocess.run([
                        'sudo', 'sed', '-i',
                        '/^127\\.0\\.1\\.1/d',
                        str(hosts_path)
                    ], check=True)
                    hosts_line = f"127.0.1.1\t{hostname}\n"
                    subprocess.run(['sudo', 'tee', '-a', str(hosts_path)],
                                 input=hosts_line.encode(),
                                 stdout=subprocess.DEVNULL, check=True)
            
            print(f"{Colors.GREEN}  âœ“ ì‹œìŠ¤í…œ ë³µì‚¬ ì™„ë£Œ!{Colors.ENDC}")
            
        except subprocess.CalledProcessError as e:
            print(f"{Colors.FAIL}  ì‹œìŠ¤í…œ ë³µì‚¬ ì‹¤íŒ¨: {e}{Colors.ENDC}")
    
    def create_client_directories(self, serial: str, mac: str, ip: str, hostname: str):
        """í´ë¼ì´ì–¸íŠ¸ìš© ë””ë ‰í† ë¦¬ ìƒì„± ë° PXE ë¶€íŒ… ì„¤ì •"""
        nfs_path = Path(self.config['nfs_root']) / serial
        tftp_path = Path(self.config['tftp_root']) / serial
        
        try:
            # ë””ë ‰í† ë¦¬ ìƒì„±
            subprocess.run(['sudo', 'mkdir', '-p', str(nfs_path)], check=True)
            subprocess.run(['sudo', 'mkdir', '-p', str(tftp_path)], check=True)
            
            # NFS ë””ë ‰í† ë¦¬ ê¶Œí•œ ì„¤ì • (ì ì ˆí•œ ê¶Œí•œ ì„¤ì •)
            subprocess.run(['sudo', 'chmod', '755', str(nfs_path)], check=True)
            
            # ì†Œìœ ì ë³€ê²½
            current_user = os.environ.get('SUDO_USER', os.environ.get('USER', 'rpi-server'))
            subprocess.run(['sudo', 'chown', f'{current_user}:{current_user}', str(nfs_path)], 
                         stderr=subprocess.DEVNULL, check=False)
            
            # TFTP ë””ë ‰í† ë¦¬ ê¶Œí•œ ì„¤ì •
            subprocess.run(['sudo', 'chmod', '755', str(tftp_path)], check=True)
            
            print(f"\n{Colors.GREEN}âœ… ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì • ì™„ë£Œ{Colors.ENDC}")
            
            # DHCP ì„¤ì • ì—…ë°ì´íŠ¸ (MAC ì£¼ì†Œì™€ ê³ ì • IP í¬í•¨)
            self.update_dhcp_config(serial, mac, ip, hostname)
            
            # NFS exports ì—…ë°ì´íŠ¸
            self.update_nfs_exports(serial)
            
            # TFTP ë¶€íŠ¸ íŒŒì¼ ì„¤ì •
            self.setup_tftp_boot_files(serial)
            
            print(f"\n{Colors.GREEN}âœ… PXE ë¶€íŒ… ì„¤ì • ì™„ë£Œ!{Colors.ENDC}")
            print(f"  - NFS: {nfs_path}")
            print(f"  - TFTP: {tftp_path}")
            print(f"  - ê³ ì • IP: {ip} (MAC: {mac})")
            
        except subprocess.CalledProcessError as e:
            print(f"{Colors.FAIL}ì„¤ì • ì‹¤íŒ¨: {e}{Colors.ENDC}")
    
    def update_dhcp_config(self, serial: str, mac: str, ip: str, hostname: str):
        """DHCP/TFTP ì„¤ì • ì—…ë°ì´íŠ¸ - í†µí•© ì„¤ì • íŒŒì¼ì— ì¶”ê°€"""
        print(f"{Colors.CYAN}DHCP ì„¤ì • ì—…ë°ì´íŠ¸ ì¤‘...{Colors.ENDC}")
        
        # í´ë¼ì´ì–¸íŠ¸ ì •ë³´ë¥¼ ì„¤ì •ì— ì¶”ê°€/ì—…ë°ì´íŠ¸
        client_exists = False
        for client in self.config.get('clients', []):
            if client['serial'] == serial:
                client['mac'] = mac
                client['ip'] = ip
                client['hostname'] = hostname
                client_exists = True
                break
        
        if not client_exists:
            if 'clients' not in self.config:
                self.config['clients'] = []
            self.config['clients'].append({
                'serial': serial,
                'mac': mac,
                'ip': ip,
                'hostname': hostname,
                'online': False
            })
        
        # ì„¤ì • ì €ì¥
        self.save_config()
        
        # í†µí•© dnsmasq ì„¤ì • ì¬ìƒì„±
        self.generate_dnsmasq_config()
        
        # DHCP ë¦¬ìŠ¤ ì—…ë°ì´íŠ¸
        self.update_dhcp_lease(mac, ip, hostname)
        
        print(f"{Colors.GREEN}  âœ“ DHCP ê³ ì • IP ì„¤ì • ì™„ë£Œ ({mac} â†’ {ip}){Colors.ENDC}")
    
    def update_dhcp_lease(self, mac: str, ip: str, hostname: str, remove: bool = False):
        """DHCP ë¦¬ìŠ¤ íŒŒì¼ ì—…ë°ì´íŠ¸"""
        try:
            lease_file = '/var/lib/misc/dnsmasq.leases'
            
            # í˜„ì¬ ë¦¬ìŠ¤ ì½ê¸°
            current_leases = []
            try:
                with open(lease_file, 'r') as f:
                    for line in f:
                        parts = line.strip().split()
                        if len(parts) >= 5:
                            # MAC ì£¼ì†Œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠëŠ” ê²ƒë§Œ ìœ ì§€
                            if parts[1] != mac and parts[2] != ip:
                                current_leases.append(line.strip())
            except FileNotFoundError:
                pass
            
            # ì œê±° ëª¨ë“œê°€ ì•„ë‹ˆë©´ ìƒˆ ë¦¬ìŠ¤ ì¶”ê°€
            if not remove and mac and ip:
                # Format: 0(infinite) mac ip hostname client_id
                new_lease = f"0 {mac} {ip} {hostname} 01:{mac.replace(':', ':')}"
                current_leases.append(new_lease)
            
            # ì„ì‹œ íŒŒì¼ì— ì“°ê¸°
            temp_lease = '/tmp/dnsmasq.leases.tmp'
            with open(temp_lease, 'w') as f:
                f.write('\n'.join(current_leases) + '\n' if current_leases else '')
            
            # ì‹¤ì œ ë¦¬ìŠ¤ íŒŒì¼ë¡œ ë³µì‚¬
            subprocess.run(['sudo', 'cp', temp_lease, lease_file], check=True)
            os.remove(temp_lease)
            
        except Exception as e:
            print(f"{Colors.WARNING}  ! ë¦¬ìŠ¤ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: {e}{Colors.ENDC}")
    
    def update_nfs_exports(self, serial: str):
        """NFS exports íŒŒì¼ ì—…ë°ì´íŠ¸"""
        print(f"{Colors.CYAN}NFS exports ì—…ë°ì´íŠ¸ ì¤‘...{Colors.ENDC}")
        
        nfs_path = f"{self.config['nfs_root']}/{serial}"
        export_line = f"{nfs_path} *(rw,sync,no_subtree_check,no_root_squash)\n"
        
        try:
            # í˜„ì¬ exports ì½ê¸°
            current_exports = ""
            try:
                with open('/etc/exports', 'r') as f:
                    current_exports = f.read()
            except:
                pass
            
            # ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
            if nfs_path not in current_exports:
                # ì¶”ê°€
                temp_exports = os.path.expanduser('~/exports_append.tmp')
                with open(temp_exports, 'w') as f:
                    f.write(export_line)
                
                subprocess.run(['sudo', 'bash', '-c', 
                              f'cat {temp_exports} >> /etc/exports'], 
                              check=True)
                os.remove(temp_exports)
                
                # NFS ì„œë¹„ìŠ¤ ì¬ì‹œì‘
                subprocess.run(['sudo', 'exportfs', '-ra'], check=True)
                subprocess.run(['sudo', 'systemctl', 'restart', 'nfs-kernel-server'],
                             stderr=subprocess.DEVNULL)
                
                print(f"{Colors.GREEN}  âœ“ NFS exports ì™„ë£Œ{Colors.ENDC}")
            else:
                print(f"{Colors.GREEN}  âœ“ NFS exports ì´ë¯¸ ì„¤ì •ë¨{Colors.ENDC}")
                
        except Exception as e:
            print(f"{Colors.WARNING}  ! NFS ì„¤ì • ì‹¤íŒ¨: {e}{Colors.ENDC}")
    
    def detect_network_interface(self, nfs_path: Path = None) -> str:
        """ì‹¤ì œ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì´ë¦„ ê°ì§€"""
        try:
            # NFS ê²½ë¡œê°€ ì œê³µë˜ë©´ í•´ë‹¹ ì‹œìŠ¤í…œì—ì„œ ê°ì§€
            if nfs_path and nfs_path.exists():
                # /sys/class/net ë””ë ‰í† ë¦¬ì—ì„œ ì¸í„°í˜ì´ìŠ¤ í™•ì¸
                net_path = nfs_path / 'sys' / 'class' / 'net'
                if net_path.exists():
                    interfaces = []
                    for item in net_path.iterdir():
                        if item.is_symlink() or item.is_dir():
                            name = item.name
                            # lo (loopback)ì™€ wlan ì¸í„°í˜ì´ìŠ¤ ì œì™¸
                            if name != 'lo' and not name.startswith('wlan'):
                                interfaces.append(name)
                    
                    if interfaces:
                        # eth0ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ ì¸í„°í˜ì´ìŠ¤ ì‚¬ìš©
                        if 'eth0' in interfaces:
                            return 'eth0'
                        # end0 íŒ¨í„´ ìš°ì„  (Raspberry Pi OSì˜ ìƒˆë¡œìš´ ëª…ëª… ê·œì¹™)
                        for iface in interfaces:
                            if iface.startswith('end'):
                                return iface
                        # ê·¸ ì™¸ ì²« ë²ˆì§¸ ìœ ì„  ì¸í„°í˜ì´ìŠ¤
                        return interfaces[0]
            
            # í˜„ì¬ ì‹œìŠ¤í…œì—ì„œ ê°ì§€ (SD ì¹´ë“œê°€ ë§ˆìš´íŠ¸ëœ ê²½ìš°)
            result = subprocess.run(['ip', 'link', 'show'], 
                                  capture_output=True, text=True, check=False)
            if result.returncode == 0:
                lines = result.stdout.split('\n')
                for line in lines:
                    if ':' in line and 'state' not in line:
                        parts = line.split(':')
                        if len(parts) >= 2:
                            iface_name = parts[1].strip()
                            # loì™€ wlan ì œì™¸
                            if iface_name != 'lo' and not iface_name.startswith('wlan'):
                                # eth0 ë˜ëŠ” endë¡œ ì‹œì‘í•˜ëŠ” ì¸í„°í˜ì´ìŠ¤ ìš°ì„ 
                                if iface_name == 'eth0' or iface_name.startswith('end'):
                                    return iface_name
            
            # ê¸°ë³¸ê°’: eth0
            return 'eth0'
            
        except Exception as e:
            print(f"{Colors.WARNING}  ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ê°ì§€ ì‹¤íŒ¨: {e}, ê¸°ë³¸ê°’ eth0 ì‚¬ìš©{Colors.ENDC}")
            return 'eth0'
    
    def setup_tftp_boot_files(self, serial: str):
        """TFTP ë¶€íŠ¸ íŒŒì¼ ì„¤ì •"""
        print(f"{Colors.CYAN}TFTP ë¶€íŠ¸ íŒŒì¼ ì„¤ì • ì¤‘...{Colors.ENDC}")
        
        tftp_path = Path(self.config['tftp_root']) / serial
        nfs_path = Path(self.config['nfs_root']) / serial
        
        # í´ë¼ì´ì–¸íŠ¸ ì •ë³´ì—ì„œ IPì™€ hostname ê°€ì ¸ì˜¤ê¸°
        client_info = next((c for c in self.config['clients'] if c['serial'] == serial), None)
        if client_info:
            client_ip = client_info.get('ip', '')
            hostname = client_info.get('hostname', serial)
        else:
            client_ip = ''
            hostname = serial
        
        try:
            # cmdline.txt ìƒì„± (ê³ ì • IPë¡œ NFS ë¶€íŒ… ì„¤ì •)
            network_base = '.'.join(self.config['server_ip'].split('.')[:3])
            gateway = f"{network_base}.1"
            netmask = "255.255.255.0"
            
            # ì‹¤ì œ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ê°ì§€
            iface = self.detect_network_interface(nfs_path)
            print(f"  ê°ì§€ëœ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤: {iface}")
            
            if client_ip:
                # ê³ ì • IP ëª…ì‹œ ë°©ì‹
                cmdline = f"console=serial0,115200 console=tty1 root=/dev/nfs nfsroot={self.config['server_ip']}:{self.config['nfs_root']}/{serial},vers=3 rw ip={client_ip}:{self.config['server_ip']}:{gateway}:{netmask}:{hostname}:{iface}:off rootwait elevator=deadline"
            else:
                # IPê°€ ì—†ìœ¼ë©´ DHCP ì‚¬ìš© (fallback)
                cmdline = f"console=serial0,115200 console=tty1 root=/dev/nfs nfsroot={self.config['server_ip']}:{self.config['nfs_root']}/{serial},vers=3 rw ip=dhcp rootwait"
            
            cmdline_file = tftp_path / 'cmdline.txt'
            temp_cmdline = os.path.expanduser('~/cmdline.txt.tmp')
            with open(temp_cmdline, 'w') as f:
                f.write(cmdline)
            
            subprocess.run(['sudo', 'cp', temp_cmdline, str(cmdline_file)], check=True)
            os.remove(temp_cmdline)
            
            # config.txt ìƒì„± (ê¸°ë³¸ ì„¤ì •)
            config = """# Network Boot Configuration
enable_uart=1
kernel=kernel8.img
"""
            config_file = tftp_path / 'config.txt'
            temp_config = os.path.expanduser('~/config.txt.tmp')
            with open(temp_config, 'w') as f:
                f.write(config)
            
            subprocess.run(['sudo', 'cp', temp_config, str(config_file)], check=True)
            os.remove(temp_config)
            
            print(f"{Colors.GREEN}  âœ“ TFTP ë¶€íŠ¸ íŒŒì¼ ìƒì„± ì™„ë£Œ{Colors.ENDC}")
            
        except Exception as e:
            print(f"{Colors.WARNING}  ! TFTP ì„¤ì • ì‹¤íŒ¨: {e}{Colors.ENDC}")
    
    def list_clients(self):
        """í´ë¼ì´ì–¸íŠ¸ ëª©ë¡ ë°˜í™˜"""
        clients = {}
        for client in self.config['clients']:
            clients[client['serial']] = {
                'hostname': client.get('hostname', 'Unknown'),
                'mac': client.get('mac', 'N/A'),
                'ip': client.get('ip', 'N/A')
            }
        return clients
    
    def remove_client(self):
        """í´ë¼ì´ì–¸íŠ¸ ì œê±°"""
        if not self.config['clients']:
            print(f"{Colors.WARNING}ì œê±°í•  í´ë¼ì´ì–¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.{Colors.ENDC}")
            time.sleep(2)
            return
        
        self.print_header()
        print(f"{Colors.BOLD}í´ë¼ì´ì–¸íŠ¸ ì œê±°{Colors.ENDC}\n")
        
        # IP ì£¼ì†Œë¡œ í´ë¼ì´ì–¸íŠ¸ ì •ë ¬
        sorted_clients = sorted(self.config['clients'], key=lambda c: self.ip_to_number(c.get('ip', 'N/A')))
        
        for i, client in enumerate(sorted_clients, 1):
            print(f"  {i}. {client['serial']} - {client.get('hostname', 'N/A')} - IP: {client.get('ip', 'N/A')}")
        print()
        
        try:
            idx = int(input("ì œê±°í•  í´ë¼ì´ì–¸íŠ¸ ë²ˆí˜¸: ")) - 1
            if 0 <= idx < len(sorted_clients):
                # ì •ë ¬ëœ ëª©ë¡ì—ì„œ ì„ íƒí•œ í´ë¼ì´ì–¸íŠ¸ ì°¾ê¸°
                selected_client = sorted_clients[idx]
                serial = selected_client['serial']
                
                # í™•ì¸ ë©”ì‹œì§€
                print(f"\n{Colors.WARNING}ê²½ê³ : ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!{Colors.ENDC}")
                print(f"ë‹¤ìŒ í•­ëª©ë“¤ì´ ì‚­ì œë©ë‹ˆë‹¤:")
                print(f"  - NFS ë””ë ‰í† ë¦¬: {self.config['nfs_root']}/{serial}")
                print(f"  - TFTP ë””ë ‰í† ë¦¬: {self.config['tftp_root']}/{serial}")
                print(f"  - DHCP ì„¤ì •: /etc/dnsmasq.d/client-{serial}.conf")
                print(f"  - NFS exports í•­ëª©")
                
                confirm = input(f"\nì •ë§ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): ").lower()
                if confirm != 'y':
                    print(f"{Colors.WARNING}ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.{Colors.ENDC}")
                    time.sleep(1)
                    return
                
                print(f"\n{Colors.CYAN}í´ë¼ì´ì–¸íŠ¸ ì œê±° ì¤‘...{Colors.ENDC}")
                
                # 1. NFS ë””ë ‰í† ë¦¬ ì‚­ì œ
                nfs_path = f"{self.config['nfs_root']}/{serial}"
                try:
                    subprocess.run(['sudo', 'rm', '-rf', nfs_path], check=True)
                    print(f"  âœ“ NFS ë””ë ‰í† ë¦¬ ì‚­ì œ: {nfs_path}")
                except:
                    print(f"  âš ï¸  NFS ë””ë ‰í† ë¦¬ ì‚­ì œ ì‹¤íŒ¨: {nfs_path}")
                
                # 2. TFTP ë””ë ‰í† ë¦¬ ì‚­ì œ
                tftp_path = f"{self.config['tftp_root']}/{serial}"
                try:
                    subprocess.run(['sudo', 'rm', '-rf', tftp_path], check=True)
                    print(f"  âœ“ TFTP ë””ë ‰í† ë¦¬ ì‚­ì œ: {tftp_path}")
                except:
                    print(f"  âš ï¸  TFTP ë””ë ‰í† ë¦¬ ì‚­ì œ ì‹¤íŒ¨: {tftp_path}")
                
                # 3. DHCP ì„¤ì • íŒŒì¼ ì‚­ì œ
                dhcp_conf = f"/etc/dnsmasq.d/client-{serial}.conf"
                try:
                    subprocess.run(['sudo', 'rm', '-f', dhcp_conf], check=True)
                    print(f"  âœ“ DHCP ì„¤ì • ì‚­ì œ: {dhcp_conf}")
                except:
                    print(f"  âš ï¸  DHCP ì„¤ì • ì‚­ì œ ì‹¤íŒ¨: {dhcp_conf}")
                
                # 4. NFS exportsì—ì„œ í•­ëª© ì œê±°
                try:
                    # exports íŒŒì¼ ì½ê¸°
                    exports_content = subprocess.run(['sudo', 'cat', '/etc/exports'], 
                                                   capture_output=True, text=True).stdout
                    
                    # í•´ë‹¹ í´ë¼ì´ì–¸íŠ¸ ë¼ì¸ ì œê±°
                    new_exports = []
                    for line in exports_content.split('\n'):
                        if serial not in line:
                            new_exports.append(line)
                    
                    # ìƒˆ exports íŒŒì¼ ì‘ì„±
                    temp_exports = os.path.expanduser('~/exports_new.tmp')
                    with open(temp_exports, 'w') as f:
                        f.write('\n'.join(new_exports))
                    
                    subprocess.run(['sudo', 'cp', temp_exports, '/etc/exports'], check=True)
                    os.remove(temp_exports)
                    
                    # NFS exports ë‹¤ì‹œ ë¡œë“œ
                    subprocess.run(['sudo', 'exportfs', '-ra'], stderr=subprocess.DEVNULL)
                    print(f"  âœ“ NFS exports í•­ëª© ì œê±°")
                except:
                    print(f"  âš ï¸  NFS exports ì—…ë°ì´íŠ¸ ì‹¤íŒ¨")
                
                # 5. ì„¤ì •ì—ì„œ ì œê±°
                self.config['clients'].remove(selected_client)
                self.save_config()
                
                # 6. dnsmasq.conf ì¬ìƒì„±
                print(f"  DHCP ì„¤ì • ì¬ìƒì„± ì¤‘...")
                self.generate_dnsmasq_config()
                
                # 7. ë¦¬ìŠ¤ íŒŒì¼ì—ì„œ ì œê±°
                if selected_client.get('mac') and selected_client.get('ip'):
                    self.update_dhcp_lease(selected_client['mac'], selected_client['ip'], 
                                         selected_client.get('hostname', serial), remove=True)
                
                # 8. dnsmasq ì¬ì‹œì‘
                try:
                    subprocess.run(['sudo', 'systemctl', 'restart', 'dnsmasq'], 
                                 stderr=subprocess.DEVNULL)
                    print(f"  âœ“ DHCP ì„œë¹„ìŠ¤ ì¬ì‹œì‘")
                except:
                    print(f"  âš ï¸  DHCP ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì‹¤íŒ¨")
                
                print(f"\n{Colors.GREEN}âœ… {serial} í´ë¼ì´ì–¸íŠ¸ê°€ ì™„ì „íˆ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.{Colors.ENDC}")
            else:
                print(f"{Colors.FAIL}ì˜ëª»ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤.{Colors.ENDC}")
        except ValueError:
            print(f"{Colors.FAIL}ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.{Colors.ENDC}")
        except Exception as e:
            print(f"{Colors.FAIL}ì œê±° ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}{Colors.ENDC}")
        
        time.sleep(2)
    
    def edit_client(self):
        """í´ë¼ì´ì–¸íŠ¸ ì •ë³´ í¸ì§‘"""
        if not self.config['clients']:
            print(f"{Colors.WARNING}í¸ì§‘í•  í´ë¼ì´ì–¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.{Colors.ENDC}")
            time.sleep(2)
            return
        
        self.print_header()
        print(f"{Colors.BOLD}í´ë¼ì´ì–¸íŠ¸ ì •ë³´ í¸ì§‘{Colors.ENDC}\n")
        
        # IP ì£¼ì†Œë¡œ í´ë¼ì´ì–¸íŠ¸ ì •ë ¬
        sorted_clients = sorted(self.config['clients'], key=lambda c: self.ip_to_number(c.get('ip', 'N/A')))
        
        # í´ë¼ì´ì–¸íŠ¸ ëª©ë¡ í‘œì‹œ
        for i, client in enumerate(sorted_clients, 1):
            print(f"  {i}. {client['serial']} - {client.get('hostname', 'N/A')}")
            print(f"     MAC: {client.get('mac', 'ì—†ìŒ')}")
            print(f"     IP: {client.get('ip', 'ì—†ìŒ')}")
        print()
        
        try:
            idx = int(input("í¸ì§‘í•  í´ë¼ì´ì–¸íŠ¸ ë²ˆí˜¸: ")) - 1
            if 0 <= idx < len(sorted_clients):
                # ì •ë ¬ëœ ëª©ë¡ì—ì„œ ì„ íƒí•œ í´ë¼ì´ì–¸íŠ¸ ì°¾ê¸°
                selected_client = sorted_clients[idx]
                # ì›ë³¸ ë¦¬ìŠ¤íŠ¸ì—ì„œ í•´ë‹¹ í´ë¼ì´ì–¸íŠ¸ì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
                original_idx = self.config['clients'].index(selected_client)
                client = self.config['clients'][original_idx]
                
                print(f"\ní˜„ì¬ ì •ë³´:")
                print(f"  ì‹œë¦¬ì–¼: {client['serial']}")
                print(f"  MAC: {client.get('mac', 'ì—†ìŒ')}")
                print(f"  IP: {client.get('ip', 'ì—†ìŒ')}")
                print(f"  í˜¸ìŠ¤íŠ¸ëª…: {client.get('hostname', 'ì—†ìŒ')}")
                
                # MAC ì£¼ì†Œ ìˆ˜ì •/ì¶”ê°€
                current_mac = client.get('mac', '')
                new_mac = input(f"\nìƒˆ MAC ì£¼ì†Œ (Enter=ìœ ì§€, í˜„ì¬: {current_mac}): ").strip().lower()
                if new_mac:
                    # MAC ì£¼ì†Œ í˜•ì‹ ê²€ì¦
                    if ':' in new_mac or '-' in new_mac:
                        new_mac = new_mac.replace('-', ':')
                        parts = new_mac.split(':')
                        if len(parts) == 6 and all(len(p) == 2 for p in parts):
                            client['mac'] = new_mac
                        else:
                            print(f"{Colors.FAIL}ì˜¬ë°”ë¥¸ MAC ì£¼ì†Œ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.{Colors.ENDC}")
                
                # IP ì£¼ì†Œ ìˆ˜ì •/ì¶”ê°€
                if not client.get('ip'):
                    # IPê°€ ì—†ìœ¼ë©´ ìë™ í• ë‹¹
                    used_ips = [c.get('ip') for c in self.config['clients'] if c.get('ip') and c != client]
                    network_prefix = ".".join(self.config['dhcp_range_start'].split('.')[:3])
                    start_num = int(self.config['dhcp_range_start'].split('.')[-1])
                    
                    suggested_ip = None
                    for i in range(start_num, start_num + 100):
                        test_ip = f"{network_prefix}.{i}"
                        if test_ip not in used_ips:
                            suggested_ip = test_ip
                            break
                    
                    new_ip = input(f"ê³ ì • IP ì£¼ì†Œ (Enter={suggested_ip}): ").strip()
                    client['ip'] = new_ip if new_ip else suggested_ip
                else:
                    new_ip = input(f"ìƒˆ IP ì£¼ì†Œ (Enter=ìœ ì§€, í˜„ì¬: {client['ip']}): ").strip()
                    if new_ip:
                        client['ip'] = new_ip
                
                # í˜¸ìŠ¤íŠ¸ëª… ìˆ˜ì •
                old_hostname = client.get('hostname', client['serial'])
                new_hostname = input(f"ìƒˆ í˜¸ìŠ¤íŠ¸ëª… (Enter=ìœ ì§€, í˜„ì¬: {old_hostname}): ").strip()
                if new_hostname and new_hostname != old_hostname:
                    client['hostname'] = new_hostname
                    
                    # ì‹¤ì œ í´ë¼ì´ì–¸íŠ¸ íŒŒì¼ ì‹œìŠ¤í…œì— í˜¸ìŠ¤íŠ¸ëª… ì—…ë°ì´íŠ¸
                    nfs_path = Path(self.config['nfs_root']) / client['serial']
                    
                    # /etc/hostname íŒŒì¼ ì—…ë°ì´íŠ¸
                    hostname_path = nfs_path / 'etc' / 'hostname'
                    if hostname_path.exists():
                        print(f"  í˜¸ìŠ¤íŠ¸ëª… íŒŒì¼ ì—…ë°ì´íŠ¸ ì¤‘...")
                        subprocess.run(['sudo', 'tee', str(hostname_path)], 
                                     input=new_hostname.encode(), 
                                     stdout=subprocess.DEVNULL, check=True)
                    
                    # /etc/hosts íŒŒì¼ ì—…ë°ì´íŠ¸
                    hosts_path = nfs_path / 'etc' / 'hosts'
                    if hosts_path.exists():
                        print(f"  hosts íŒŒì¼ ì—…ë°ì´íŠ¸ ì¤‘...")
                        # ë¨¼ì € ê¸°ì¡´ í˜¸ìŠ¤íŠ¸ëª…ì„ ìƒˆ í˜¸ìŠ¤íŠ¸ëª…ìœ¼ë¡œ ë³€ê²½
                        subprocess.run([
                            'sudo', 'sed', '-i',
                            f's/\\b{old_hostname}\\b/{new_hostname}/g',
                            str(hosts_path)
                        ], check=True)
                        
                        # raspberrypiê°€ ë‚¨ì•„ìˆìœ¼ë©´ ê·¸ê²ƒë„ ë³€ê²½
                        subprocess.run([
                            'sudo', 'sed', '-i',
                            f's/\\braspberrypi\\b/{new_hostname}/g',
                            str(hosts_path)
                        ], check=True)
                    
                    print(f"{Colors.GREEN}  âœ“ í´ë¼ì´ì–¸íŠ¸ íŒŒì¼ ì‹œìŠ¤í…œì˜ í˜¸ìŠ¤íŠ¸ëª…ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤{Colors.ENDC}")
                    print(f"{Colors.YELLOW}  â€» ë³€ê²½ì‚¬í•­ ì ìš©ì„ ìœ„í•´ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì¬ë¶€íŒ…í•´ì£¼ì„¸ìš”{Colors.ENDC}")
                
                self.config['clients'][original_idx] = client
                self.save_config()
                
                print(f"\n{Colors.GREEN}âœ… í´ë¼ì´ì–¸íŠ¸ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.{Colors.ENDC}")
                
                # ì„¤ì • íŒŒì¼ ì¬ìƒì„±
                if client.get('mac') and client.get('ip'):
                    print("\nPXE ì„¤ì •ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤...")
                    # ì´ì „ MAC/IP ë¦¬ìŠ¤ ì œê±°
                    if 'mac' in selected_client and 'ip' in selected_client:
                        self.update_dhcp_lease(selected_client['mac'], selected_client['ip'], 
                                             selected_client.get('hostname', ''), remove=True)
                    self.update_dhcp_config(client['serial'], client['mac'], client['ip'], client.get('hostname', f"rpi-{client['serial'][-6:]}"))
                    
                    # dnsmasq ì„œë¹„ìŠ¤ ì¬ì‹œì‘
                    try:
                        subprocess.run(['sudo', 'systemctl', 'restart', 'dnsmasq'], 
                                     stderr=subprocess.DEVNULL, check=True)
                        print(f"{Colors.GREEN}  âœ“ DHCP ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì™„ë£Œ{Colors.ENDC}")
                    except:
                        print(f"{Colors.WARNING}  âš ï¸  DHCP ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì‹¤íŒ¨{Colors.ENDC}")
                
            else:
                print(f"{Colors.FAIL}ì˜ëª»ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤.{Colors.ENDC}")
        except ValueError:
            print(f"{Colors.FAIL}ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.{Colors.ENDC}")
        
        time.sleep(2)
    
    def copy_from_sd(self):
        """SD ì¹´ë“œì—ì„œ ì‹œìŠ¤í…œ ë³µì‚¬"""
        self.print_header()
        print(f"{Colors.BOLD}SD ì¹´ë“œì—ì„œ ì‹œìŠ¤í…œ ë³µì‚¬{Colors.ENDC}\n")
        
        # í´ë¼ì´ì–¸íŠ¸ ëª©ë¡ í™•ì¸
        clients = self.list_clients()
        if not clients:
            print(f"{Colors.FAIL}ë“±ë¡ëœ í´ë¼ì´ì–¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í´ë¼ì´ì–¸íŠ¸ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.{Colors.ENDC}")
            time.sleep(2)
            return
        
        # í´ë¼ì´ì–¸íŠ¸ ì„ íƒ
        print(f"{Colors.BOLD}ëŒ€ìƒ í´ë¼ì´ì–¸íŠ¸ ì„ íƒ:{Colors.ENDC}")
        for idx, (serial, info) in enumerate(clients.items(), 1):
            hostname = info.get('hostname', 'Unknown')
            print(f"  {Colors.CYAN}{idx}.{Colors.ENDC} {serial} ({hostname})")
        print()
        
        try:
            choice = int(input(f"{Colors.CYAN}í´ë¼ì´ì–¸íŠ¸ ë²ˆí˜¸: {Colors.ENDC}"))
            if choice < 1 or choice > len(clients):
                print(f"{Colors.FAIL}ì˜ëª»ëœ ë²ˆí˜¸ì…ë‹ˆë‹¤.{Colors.ENDC}")
                time.sleep(2)
                return
            
            serial = list(clients.keys())[choice - 1]
        except ValueError:
            print(f"{Colors.FAIL}ì˜ëª»ëœ ì…ë ¥ì…ë‹ˆë‹¤.{Colors.ENDC}")
            time.sleep(2)
            return
        
        # SD ì¹´ë“œ ê°ì§€
        print(f"\n{Colors.BOLD}SD ì¹´ë“œ ê°ì§€ ì¤‘...{Colors.ENDC}")
        result = subprocess.run(['lsblk', '-o', 'NAME,SIZE,TYPE,MOUNTPOINT', '-p', '--raw'], 
                              capture_output=True, text=True)
        
        # SD ì¹´ë“œ íŒŒí‹°ì…˜ ì°¾ê¸°
        lines = result.stdout.strip().split('\n')
        devices = []
        for line in lines[1:]:  # í—¤ë” ì œì™¸
            parts = line.split()
            if len(parts) >= 3:
                name = parts[0]
                # íŠ¸ë¦¬ ë¬¸ì ì œê±°
                name = name.replace('â”œâ”€', '').replace('â””â”€', '').replace('â”‚', '').strip()
                if '/dev/sd' in name or '/dev/mmcblk' in name:
                    # íŒŒí‹°ì…˜ì´ ìˆëŠ” ë””ìŠ¤í¬ë§Œ
                    if any(char.isdigit() for char in name.split('/')[-1]):
                        parts[0] = name  # ì •ë¦¬ëœ ì´ë¦„ìœ¼ë¡œ êµì²´
                        devices.append(parts)
        
        if not devices:
            print(f"{Colors.FAIL}SD ì¹´ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.{Colors.ENDC}")
            print(f"{Colors.WARNING}SD ì¹´ë“œê°€ ì‚½ì…ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.{Colors.ENDC}")
            time.sleep(3)
            return
        
        print(f"\n{Colors.BOLD}ê°ì§€ëœ íŒŒí‹°ì…˜:{Colors.ENDC}")
        print(f"{'ë²ˆí˜¸':<5} {'ì¥ì¹˜':<20} {'í¬ê¸°':<10} {'ë§ˆìš´íŠ¸':<20}")
        print("-" * 55)
        for idx, parts in enumerate(devices, 1):
            name = parts[0]
            size = parts[1] if len(parts) > 1 else 'N/A'
            mount = parts[-1] if len(parts) > 3 and parts[-1].startswith('/') else 'Not mounted'
            print(f"{idx:<5} {name:<20} {size:<10} {mount:<20}")
        
        print(f"\n{Colors.WARNING}ì¼ë°˜ì ìœ¼ë¡œ Raspberry Pi OSëŠ” 2ê°œì˜ íŒŒí‹°ì…˜ì„ ê°€ì§‘ë‹ˆë‹¤:{Colors.ENDC}")
        print(f"  - boot íŒŒí‹°ì…˜ (FAT32, ì•½ 256MB)")
        print(f"  - root íŒŒí‹°ì…˜ (ext4, ë‚˜ë¨¸ì§€ ìš©ëŸ‰)")
        
        # íŒŒí‹°ì…˜ ì„ íƒ
        boot_num = input(f"\n{Colors.CYAN}boot íŒŒí‹°ì…˜ ë²ˆí˜¸: {Colors.ENDC}").strip()
        root_num = input(f"{Colors.CYAN}root íŒŒí‹°ì…˜ ë²ˆí˜¸: {Colors.ENDC}").strip()
        
        try:
            boot_idx = int(boot_num) - 1
            root_idx = int(root_num) - 1
            
            if boot_idx < 0 or boot_idx >= len(devices) or root_idx < 0 or root_idx >= len(devices):
                raise ValueError
            
            boot_device = devices[boot_idx][0]
            root_device = devices[root_idx][0]
        except (ValueError, IndexError):
            print(f"{Colors.FAIL}ì˜ëª»ëœ íŒŒí‹°ì…˜ ë²ˆí˜¸ì…ë‹ˆë‹¤.{Colors.ENDC}")
            time.sleep(2)
            return
        
        # ëŒ€ìƒ ê²½ë¡œ í™•ì¸
        nfs_path = os.path.join(self.config['nfs_root'], serial)
        tftp_path = os.path.join(self.config['tftp_root'], serial)
        
        print(f"\n{Colors.BOLD}ë³µì‚¬ ì •ë³´:{Colors.ENDC}")
        print(f"  Boot íŒŒí‹°ì…˜: {boot_device} â†’ {tftp_path}")
        print(f"  Root íŒŒí‹°ì…˜: {root_device} â†’ {nfs_path}")
        
        confirm = input(f"\n{Colors.WARNING}ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): {Colors.ENDC}").lower()
        if confirm != 'y':
            print(f"{Colors.WARNING}ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.{Colors.ENDC}")
            time.sleep(2)
            return
        
        # ì„ì‹œ ë§ˆìš´íŠ¸ í¬ì¸íŠ¸ ìƒì„±
        temp_boot = f"/tmp/sd_boot_{serial}"
        temp_root = f"/tmp/sd_root_{serial}"
        
        try:
            # ì„ì‹œ ë””ë ‰í† ë¦¬ ìƒì„±
            subprocess.run(['sudo', 'mkdir', '-p', temp_boot, temp_root], check=True)
            
            # SD ì¹´ë“œ ë§ˆìš´íŠ¸
            print(f"\n{Colors.WARNING}SD ì¹´ë“œ ë§ˆìš´íŠ¸ ì¤‘...{Colors.ENDC}")
            subprocess.run(['sudo', 'mount', boot_device, temp_boot], check=True)
            subprocess.run(['sudo', 'mount', root_device, temp_root], check=True)
            
            # ë³µì‚¬ ì‹œì‘
            print(f"{Colors.WARNING}ì‹œìŠ¤í…œ ë³µì‚¬ ì¤‘... (ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤){Colors.ENDC}")
            
            # Boot íŒŒí‹°ì…˜ ë³µì‚¬
            print(f"  Boot íŒŒí‹°ì…˜ ë³µì‚¬ ì¤‘...")
            subprocess.run(['sudo', 'cp', '-a', f"{temp_boot}/.", tftp_path], check=True)
            
            # Root íŒŒí‹°ì…˜ ë³µì‚¬ (rsync ì‚¬ìš©)
            print(f"  Root íŒŒí‹°ì…˜ ë³µì‚¬ ì¤‘... (ëª‡ ë¶„ ì†Œìš”)")
            subprocess.run([
                'sudo', 'rsync', '-aHAXx', '--info=progress2',
                '--exclude=captures', '--exclude=videos', '--exclude=*.log',
                f"{temp_root}/", f"{nfs_path}/"
            ], check=True)
            
            # cmdline.txt ìˆ˜ì • (ë„¤íŠ¸ì›Œí¬ ë¶€íŒ…ìš© - ê³ ì • IP ëª…ì‹œ)
            cmdline_path = os.path.join(tftp_path, 'cmdline.txt')
            
            # í´ë¼ì´ì–¸íŠ¸ ì •ë³´ì—ì„œ IPì™€ hostname ê°€ì ¸ì˜¤ê¸°
            client_info = next((c for c in self.config['clients'] if c['serial'] == serial), None)
            if client_info:
                client_ip = client_info.get('ip', '')
                hostname = client_info.get('hostname', serial)
            else:
                client_ip = ''
                hostname = serial
            
            # ë„¤íŠ¸ì›Œí¬ ì„¤ì •
            network_base = '.'.join(self.config['server_ip'].split('.')[:3])
            gateway = f"{network_base}.1"
            netmask = "255.255.255.0"
            
            # ë§ˆìš´íŠ¸ëœ root íŒŒí‹°ì…˜ì—ì„œ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ê°ì§€
            iface = self.detect_network_interface(Path(temp_root))
            print(f"  ê°ì§€ëœ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤: {iface}")
            
            if client_ip:
                # ê³ ì • IP ëª…ì‹œ ë°©ì‹
                cmdline = f"console=serial0,115200 console=tty1 root=/dev/nfs nfsroot={self.config['server_ip']}:{nfs_path},vers=3 rw ip={client_ip}:{self.config['server_ip']}:{gateway}:{netmask}:{hostname}:{iface}:off rootwait elevator=deadline"
            else:
                # IPê°€ ì—†ìœ¼ë©´ DHCP ì‚¬ìš© (fallback)
                cmdline = f"console=serial0,115200 console=tty1 root=/dev/nfs nfsroot={self.config['server_ip']}:{nfs_path},vers=3 rw ip=dhcp rootwait"
            
            # cmdline.txt ì—…ë°ì´íŠ¸
            subprocess.run(['sudo', 'tee', cmdline_path], input=cmdline.encode(), 
                         stdout=subprocess.DEVNULL, check=True)
            print(f"  cmdline.txt ì—…ë°ì´íŠ¸ ì™„ë£Œ (IP: {client_ip if client_ip else 'DHCP'})")
            
            # fstab ìˆ˜ì • (ìµœì†Œ ì„¤ì •ìœ¼ë¡œ ë‹¨ìˆœí™”)
            fstab_path = os.path.join(nfs_path, 'etc', 'fstab')
            if os.path.exists(fstab_path):
                # ìµœì†Œí•œì˜ fstab ì„¤ì •ë§Œ ìœ ì§€ (working client ì°¸ì¡°)
                minimal_fstab = """proc            /proc           proc    defaults          0       0
tmpfs           /tmp            tmpfs   defaults,nosuid   0       0
devpts          /dev/pts        devpts  gid=5,mode=620    0       0
"""
                subprocess.run(['sudo', 'tee', fstab_path], 
                             input=minimal_fstab.encode(), stdout=subprocess.DEVNULL, check=True)
                print(f"  fstab ë‹¨ìˆœí™” ì™„ë£Œ (ìµœì†Œ ì„¤ì •)")
            
            # Root ê³„ì •ì€ ê¸°ë³¸ ìƒíƒœ ìœ ì§€ (ì ê¸ˆ ìƒíƒœ * ìœ ì§€)
            # Raspberry Pi OSëŠ” ê¸°ë³¸ì ìœ¼ë¡œ pi ì‚¬ìš©ìë¡œ ì ‘ê·¼í•˜ë„ë¡ ì„¤ê³„ë¨
            print(f"  ë³´ì•ˆ ì„¤ì • ìœ ì§€ (pi ì‚¬ìš©ì ì‚¬ìš©)")
            
            # hostname ì„¤ì • (ì‹œë¦¬ì–¼ ë²ˆí˜¸ ì‚¬ìš©)
            hostname_path = os.path.join(nfs_path, 'etc', 'hostname')
            if os.path.exists(hostname_path):
                # í´ë¼ì´ì–¸íŠ¸ ì •ë³´ì—ì„œ hostname ê°€ì ¸ì˜¤ê¸° (ì‹œë¦¬ì–¼ ë²ˆí˜¸)
                client_info = next((c for c in self.config['clients'] if c['serial'] == serial), None)
                if client_info:
                    hostname = client_info.get('hostname', serial)
                else:
                    hostname = serial
                    
                subprocess.run(['sudo', 'tee', hostname_path], 
                             input=hostname.encode(), 
                             stdout=subprocess.DEVNULL, check=True)
                print(f"  hostname ì„¤ì • ì™„ë£Œ: {hostname}")
                
                # /etc/hosts íŒŒì¼ë„ ìˆ˜ì •
                hosts_path = os.path.join(nfs_path, 'etc', 'hosts')
                if os.path.exists(hosts_path):
                    # ê¸°ì¡´ raspberrypië¥¼ ìƒˆ hostnameìœ¼ë¡œ ë³€ê²½
                    subprocess.run([
                        'sudo', 'sed', '-i',
                        f's/\\braspberrypi\\b/{hostname}/g',
                        hosts_path
                    ], check=True)
                    
                    # 127.0.1.1 ë¼ì¸ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ìˆ˜ì •
                    subprocess.run([
                        'sudo', 'sed', '-i',
                        f'/^127\\.0\\.1\\.1/d',  # ê¸°ì¡´ 127.0.1.1 ë¼ì¸ ì‚­ì œ
                        hosts_path
                    ], check=True)
                    
                    # ìƒˆë¡œìš´ 127.0.1.1 ë¼ì¸ ì¶”ê°€
                    hosts_line = f"127.0.1.1\t{hostname}\n"
                    subprocess.run(['sudo', 'tee', '-a', hosts_path],
                                 input=hosts_line.encode(),
                                 stdout=subprocess.DEVNULL, check=True)
                    print(f"  /etc/hosts ì—…ë°ì´íŠ¸ ì™„ë£Œ")
            
            # SSH ì„¤ì • ë° í‚¤ ì¬ìƒì„±
            self.setup_ssh_for_client(Path(nfs_path), hostname)
            
            # NFS ê¶Œí•œ ì„¤ì • (ì ì ˆí•œ ê¶Œí•œ ì„¤ì •, SSH í‚¤ íŒŒì¼ ì œì™¸)
            # ê¸°ë³¸ ë””ë ‰í† ë¦¬ëŠ” 755
            subprocess.run(['sudo', 'chmod', '755', nfs_path], check=True)
            # SSH ë””ë ‰í† ë¦¬ì™€ íŒŒì¼ì€ ë³„ë„ ì²˜ë¦¬ (setup_ssh_for_clientì—ì„œ ì²˜ë¦¬ë¨)
            print(f"  NFS ë””ë ‰í† ë¦¬ ê¶Œí•œ ì„¤ì • ì™„ë£Œ")
            
            # ì†Œìœ ì ë³€ê²½
            current_user = os.environ.get('SUDO_USER', os.environ.get('USER', 'rpi-server'))
            subprocess.run(['sudo', 'chown', '-R', f'{current_user}:{current_user}', nfs_path], 
                         stderr=subprocess.DEVNULL, check=False)
            print(f"  NFS ë””ë ‰í† ë¦¬ ì†Œìœ ì ë³€ê²½ ì™„ë£Œ ({current_user})")
            
            print(f"\n{Colors.GREEN}âœ… SD ì¹´ë“œ ì‹œìŠ¤í…œ ë³µì‚¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!{Colors.ENDC}")
            print(f"{Colors.GREEN}í´ë¼ì´ì–¸íŠ¸ {serial}ì´ ë„¤íŠ¸ì›Œí¬ ë¶€íŒ…í•  ì¤€ë¹„ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.{Colors.ENDC}")
            
        except subprocess.CalledProcessError as e:
            print(f"{Colors.FAIL}ì˜¤ë¥˜ ë°œìƒ: {e}{Colors.ENDC}")
        finally:
            # ì–¸ë§ˆìš´íŠ¸
            print(f"\nì •ë¦¬ ì¤‘...")
            subprocess.run(['sudo', 'umount', temp_boot], stderr=subprocess.DEVNULL)
            subprocess.run(['sudo', 'umount', temp_root], stderr=subprocess.DEVNULL)
            subprocess.run(['sudo', 'rmdir', temp_boot, temp_root], stderr=subprocess.DEVNULL)
        
        time.sleep(3)
    
    def server_settings(self):
        """ì„œë²„ ì„¤ì •"""
        while True:
            self.print_header()
            print(f"{Colors.BOLD}ì„œë²„ ì„¤ì •{Colors.ENDC}\n")
            
            print(f"{Colors.BOLD}í˜„ì¬ ì„¤ì •:{Colors.ENDC}")
            print(f"  ì„œë²„ IP: {self.config['server_ip']}")
            print(f"  DHCP ë²”ìœ„: {self.config['dhcp_range_start']} - {self.config['dhcp_range_end']}")
            print(f"  ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤: {self.config['network_interface']}")
            print(f"  NFS ë£¨íŠ¸: {self.config['nfs_root']}")
            print(f"  TFTP ë£¨íŠ¸: {self.config['tftp_root']}")
            print()
            
            # ProxyDHCP ëª¨ë“œ ìƒíƒœ í‘œì‹œ
            proxy_mode = self.config.get('proxy_dhcp_mode', False)
            mode_status = f"{Colors.GREEN}í™œì„±í™”{Colors.ENDC}" if proxy_mode else f"{Colors.WARNING}ë¹„í™œì„±í™”{Colors.ENDC}"
            print(f"  ProxyDHCP ëª¨ë“œ: {mode_status}")
            print()
            
            print(f"{Colors.BOLD}ì˜µì…˜:{Colors.ENDC}")
            print(f"  {Colors.CYAN}1.{Colors.ENDC} ì„œë²„ IP ë³€ê²½")
            print(f"  {Colors.CYAN}2.{Colors.ENDC} DHCP ë²”ìœ„ ë³€ê²½")
            print(f"  {Colors.CYAN}3.{Colors.ENDC} ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ë³€ê²½")
            print(f"  {Colors.CYAN}4.{Colors.ENDC} NFS/TFTP ê²½ë¡œ ë³€ê²½")
            print(f"  {Colors.CYAN}5.{Colors.ENDC} ProxyDHCP ëª¨ë“œ ì „í™˜")
            print(f"  {Colors.CYAN}6.{Colors.ENDC} DHCP ì¶©ëŒ ê²€ì‚¬")
            print(f"  {Colors.CYAN}0.{Colors.ENDC} ë’¤ë¡œ ê°€ê¸°")
            print()
            
            choice = input(f"{Colors.CYAN}ì„ íƒ: {Colors.ENDC}")
            
            if choice == '1':
                new_ip = input("ìƒˆ ì„œë²„ IP: ").strip()
                if new_ip:
                    self.config['server_ip'] = new_ip
                    self.save_config()
                    print(f"{Colors.GREEN}âœ… ì„œë²„ IPê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.{Colors.ENDC}")
                    time.sleep(2)
            elif choice == '2':
                start = input("DHCP ì‹œì‘ IP: ").strip()
                end = input("DHCP ì¢…ë£Œ IP: ").strip()
                if start and end:
                    self.config['dhcp_range_start'] = start
                    self.config['dhcp_range_end'] = end
                    self.save_config()
                    print(f"{Colors.GREEN}âœ… DHCP ë²”ìœ„ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.{Colors.ENDC}")
                    time.sleep(2)
            elif choice == '3':
                # ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ì„ íƒ
                interfaces = self.get_network_interfaces()
                if interfaces:
                    print(f"\n{Colors.BOLD}ì‚¬ìš© ê°€ëŠ¥í•œ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤:{Colors.ENDC}")
                    for i, (iface, ip) in enumerate(interfaces, 1):
                        current = " (í˜„ì¬)" if iface == self.config['network_interface'] else ""
                        print(f"  {Colors.CYAN}{i}.{Colors.ENDC} {iface:<15} IP: {ip}{current}")
                    print(f"  {Colors.CYAN}0.{Colors.ENDC} ìˆ˜ë™ ì…ë ¥")
                    
                    choice_iface = input("\nì„ íƒ: ").strip()
                    if choice_iface == '0':
                        iface = input("ì¸í„°í˜ì´ìŠ¤ ì´ë¦„: ").strip()
                    else:
                        try:
                            idx = int(choice_iface) - 1
                            if 0 <= idx < len(interfaces):
                                iface = interfaces[idx][0]
                            else:
                                print(f"{Colors.FAIL}ì˜ëª»ëœ ì„ íƒ{Colors.ENDC}")
                                time.sleep(2)
                                continue
                        except:
                            print(f"{Colors.FAIL}ì˜ëª»ëœ ì…ë ¥{Colors.ENDC}")
                            time.sleep(2)
                            continue
                    
                    if iface:
                        self.config['network_interface'] = iface
                        self.save_config()
                        print(f"{Colors.GREEN}âœ… ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ê°€ {iface}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.{Colors.ENDC}")
                        time.sleep(2)
                else:
                    iface = input("ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤: ").strip()
                    if iface:
                        self.config['network_interface'] = iface
                        self.save_config()
                        print(f"{Colors.GREEN}âœ… ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.{Colors.ENDC}")
                        time.sleep(2)
            elif choice == '4':
                nfs = input(f"NFS ë£¨íŠ¸ ê²½ë¡œ (í˜„ì¬: {self.config['nfs_root']}): ").strip()
                tftp = input(f"TFTP ë£¨íŠ¸ ê²½ë¡œ (í˜„ì¬: {self.config['tftp_root']}): ").strip()
                if nfs:
                    self.config['nfs_root'] = nfs
                if tftp:
                    self.config['tftp_root'] = tftp
                self.save_config()
                print(f"{Colors.GREEN}âœ… ê²½ë¡œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.{Colors.ENDC}")
                time.sleep(2)
            elif choice == '5':
                # ProxyDHCP ëª¨ë“œ ì „í™˜
                current_mode = self.config.get('proxy_dhcp_mode', False)
                print(f"\n{Colors.BOLD}ProxyDHCP ëª¨ë“œ ì„¤ì •{Colors.ENDC}")
                print(f"í˜„ì¬ ìƒíƒœ: {'í™œì„±í™”' if current_mode else 'ë¹„í™œì„±í™”'}")
                print(f"\n{Colors.WARNING}ProxyDHCP ëª¨ë“œ ì„¤ëª…:{Colors.ENDC}")
                print("  - í™œì„±í™”: ê³µìœ ê¸°ì™€ í•¨ê»˜ ë™ì‘ (ê³µìœ ê¸°ê°€ IP í• ë‹¹, PXE ì„œë²„ëŠ” ë¶€íŒ… ì •ë³´ë§Œ ì œê³µ)")
                print("  - ë¹„í™œì„±í™”: PXE ì„œë²„ê°€ ì „ì²´ DHCP ì„œë¹„ìŠ¤ ì œê³µ (ê³µìœ ê¸° DHCP ë¹„í™œì„±í™” í•„ìš”)")
                
                toggle = input(f"\nëª¨ë“œë¥¼ {'ë¹„í™œì„±í™”' if current_mode else 'í™œì„±í™”'}í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/n): ").lower()
                if toggle == 'y':
                    self.config['proxy_dhcp_mode'] = not current_mode
                    self.save_config()
                    print(f"{Colors.GREEN}âœ… ProxyDHCP ëª¨ë“œê°€ {'í™œì„±í™”' if not current_mode else 'ë¹„í™œì„±í™”'}ë˜ì—ˆìŠµë‹ˆë‹¤.{Colors.ENDC}")
                    print(f"{Colors.WARNING}ë³€ê²½ì‚¬í•­ì„ ì ìš©í•˜ë ¤ë©´ dnsmasq ì„œë¹„ìŠ¤ë¥¼ ì¬ì‹œì‘í•˜ì„¸ìš”.{Colors.ENDC}")
                    time.sleep(3)
            elif choice == '6':
                # DHCP ì¶©ëŒ ê²€ì‚¬
                self.check_dhcp_conflicts()
            elif choice == '0':
                break
    
    def manage_services(self):
        """ì„œë¹„ìŠ¤ ê´€ë¦¬"""
        services = {
            '1': ('dnsmasq', 'DHCP/TFTP ì„œë²„'),
            '2': ('nfs-kernel-server', 'NFS ì„œë²„'),
            '3': ('tftpd-hpa', 'TFTP ì„œë²„'),
        }
        
        while True:
            self.print_header()
            print(f"{Colors.BOLD}ì„œë¹„ìŠ¤ ê´€ë¦¬{Colors.ENDC}\n")
            
            # ì„œë¹„ìŠ¤ ìƒíƒœ í‘œì‹œ
            for key, (service, desc) in services.items():
                result = subprocess.run(['systemctl', 'is-active', service], 
                                      capture_output=True, text=True)
                status = result.stdout.strip() == 'active'
                icon = "âœ…" if status else "âŒ"
                color = Colors.GREEN if status else Colors.FAIL
                print(f"  {key}. {icon} {color}{desc:<20}{Colors.ENDC} ({service})")
            print()
            
            print(f"{Colors.BOLD}ì‘ì—…:{Colors.ENDC}")
            print(f"  {Colors.CYAN}s.{Colors.ENDC} ì‹œì‘ (ë²ˆí˜¸ ì…ë ¥)")
            print(f"  {Colors.CYAN}t.{Colors.ENDC} ì¤‘ì§€ (ë²ˆí˜¸ ì…ë ¥)")
            print(f"  {Colors.CYAN}r.{Colors.ENDC} ì¬ì‹œì‘ (ë²ˆí˜¸ ì…ë ¥)")
            print(f"  {Colors.CYAN}a.{Colors.ENDC} ëª¨ë‘ ì‹œì‘")
            print(f"  {Colors.CYAN}0.{Colors.ENDC} ë’¤ë¡œ ê°€ê¸°")
            print()
            
            choice = input(f"{Colors.CYAN}ì„ íƒ: {Colors.ENDC}").lower()
            
            if choice == '0':
                break
            elif choice == 'a':
                for _, (service, _) in services.items():
                    subprocess.run(['sudo', 'systemctl', 'start', service])
                print(f"{Colors.GREEN}âœ… ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ì‹œì‘í–ˆìŠµë‹ˆë‹¤.{Colors.ENDC}")
                time.sleep(2)
            elif choice.startswith('s') or choice.startswith('t') or choice.startswith('r'):
                action = {'s': 'start', 't': 'stop', 'r': 'restart'}[choice[0]]
                num = input(f"ì„œë¹„ìŠ¤ ë²ˆí˜¸: ")
                if num in services:
                    service, _ = services[num]
                    subprocess.run(['sudo', 'systemctl', action, service])
                    print(f"{Colors.GREEN}âœ… {service} ì„œë¹„ìŠ¤ë¥¼ {action}í–ˆìŠµë‹ˆë‹¤.{Colors.ENDC}")
                    time.sleep(2)
    
    def view_logs(self):
        """ë¡œê·¸ í™•ì¸"""
        self.print_header()
        print(f"{Colors.BOLD}ë¡œê·¸ í™•ì¸{Colors.ENDC}\n")
        
        print(f"  {Colors.CYAN}1.{Colors.ENDC} dnsmasq ë¡œê·¸")
        print(f"  {Colors.CYAN}2.{Colors.ENDC} NFS ë¡œê·¸")
        print(f"  {Colors.CYAN}3.{Colors.ENDC} ì‹œìŠ¤í…œ ë¡œê·¸")
        print()
        
        choice = input(f"{Colors.CYAN}ì„ íƒ: {Colors.ENDC}")
        
        if choice == '1':
            subprocess.run(['sudo', 'journalctl', '-u', 'dnsmasq', '-n', '50'])
        elif choice == '2':
            subprocess.run(['sudo', 'journalctl', '-u', 'nfs-kernel-server', '-n', '50'])
        elif choice == '3':
            subprocess.run(['sudo', 'journalctl', '-n', '50'])
        
        input(f"\n{Colors.CYAN}Enterë¥¼ ëˆŒëŸ¬ ê³„ì†...{Colors.ENDC}")
    
    def check_dhcp_conflicts(self):
        """DHCP ì¶©ëŒ ê²€ì‚¬"""
        self.print_header()
        print(f"{Colors.BOLD}DHCP ì¶©ëŒ ê²€ì‚¬{Colors.ENDC}\n")
        
        print(f"{Colors.CYAN}ë„¤íŠ¸ì›Œí¬ì—ì„œ DHCP ì„œë²„ë¥¼ ê²€ìƒ‰ ì¤‘...{Colors.ENDC}")
        
        # nmapì„ ì‚¬ìš©í•œ DHCP ì„œë²„ ê²€ìƒ‰ (ê°€ëŠ¥í•œ ê²½ìš°)
        try:
            result = subprocess.run(
                ['sudo', 'nmap', '--script', 'broadcast-dhcp-discover'],
                capture_output=True, text=True, timeout=10
            )
            
            if result.returncode == 0:
                print(f"\n{Colors.BOLD}ê²€ìƒ‰ ê²°ê³¼:{Colors.ENDC}")
                print(result.stdout)
                
                # ì—¬ëŸ¬ DHCP ì„œë²„ê°€ ë°œê²¬ëœ ê²½ìš° ê²½ê³ 
                if result.stdout.count('DHCP Offer') > 1:
                    print(f"\n{Colors.FAIL}âš ï¸  ê²½ê³ : ë„¤íŠ¸ì›Œí¬ì— ì—¬ëŸ¬ DHCP ì„œë²„ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!{Colors.ENDC}")
                    print(f"{Colors.WARNING}ProxyDHCP ëª¨ë“œë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ í•˜ë‚˜ì˜ DHCP ì„œë²„ë§Œ í™œì„±í™”í•˜ì„¸ìš”.{Colors.ENDC}")
                else:
                    print(f"\n{Colors.GREEN}âœ… DHCP ì¶©ëŒì´ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.{Colors.ENDC}")
            else:
                raise subprocess.CalledProcessError(result.returncode, 'nmap')
                
        except (subprocess.CalledProcessError, subprocess.TimeoutExpired, FileNotFoundError):
            # nmapì´ ì—†ê±°ë‚˜ ì‹¤íŒ¨í•œ ê²½ìš° ëŒ€ì²´ ë°©ë²•
            print(f"\n{Colors.WARNING}nmapì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤...{Colors.ENDC}")
            
            # ARP í…Œì´ë¸”ì—ì„œ ê²Œì´íŠ¸ì›¨ì´ í™•ì¸
            try:
                arp_result = subprocess.run(['arp', '-n'], capture_output=True, text=True)
                gateway_ip = '.'.join(self.config['server_ip'].split('.')[:3]) + '.1'
                
                if gateway_ip in arp_result.stdout:
                    print(f"\n{Colors.WARNING}âš ï¸  ê³µìœ ê¸°/ê²Œì´íŠ¸ì›¨ì´({gateway_ip})ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.{Colors.ENDC}")
                    print(f"ê³µìœ ê¸°ì— DHCP ì„œë²„ê°€ í™œì„±í™”ë˜ì–´ ìˆì„ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤.")
                    print(f"\n{Colors.BOLD}í•´ê²° ë°©ë²•:{Colors.ENDC}")
                    print(f"  1. ProxyDHCP ëª¨ë“œ ì‚¬ìš© (ê¶Œì¥)")
                    print(f"  2. ê³µìœ ê¸° DHCP ë¹„í™œì„±í™”")
                    print(f"  3. MAC ì£¼ì†Œ ê¸°ë°˜ í•„í„°ë§ ì‚¬ìš©")
                    
                # í˜„ì¬ dnsmasq ìƒíƒœ í™•ì¸
                dnsmasq_status = subprocess.run(
                    ['systemctl', 'is-active', 'dnsmasq'],
                    capture_output=True, text=True
                ).stdout.strip()
                
                print(f"\n{Colors.BOLD}PXE ì„œë²„ ìƒíƒœ:{Colors.ENDC}")
                print(f"  dnsmasq: {Colors.GREEN if dnsmasq_status == 'active' else Colors.FAIL}{dnsmasq_status}{Colors.ENDC}")
                
                if self.config.get('proxy_dhcp_mode', False):
                    print(f"  ëª¨ë“œ: {Colors.GREEN}ProxyDHCP (ì¶©ëŒ ë°©ì§€){Colors.ENDC}")
                else:
                    print(f"  ëª¨ë“œ: {Colors.WARNING}ì¼ë°˜ DHCP (ì¶©ëŒ ê°€ëŠ¥){Colors.ENDC}")
                    
            except Exception as e:
                print(f"{Colors.FAIL}ê²€ì‚¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}{Colors.ENDC}")
        
        input(f"\n{Colors.CYAN}Enterë¥¼ ëˆŒëŸ¬ ê³„ì†...{Colors.ENDC}")
    
    def get_network_interfaces(self):
        """ì‚¬ìš© ê°€ëŠ¥í•œ ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°"""
        interfaces = []
        for iface in netifaces.interfaces():
            if iface == 'lo':  # ë£¨í”„ë°± ì œì™¸
                continue
            addrs = netifaces.ifaddresses(iface)
            if netifaces.AF_INET in addrs:  # IPv4 ì£¼ì†Œê°€ ìˆëŠ” ì¸í„°í˜ì´ìŠ¤ë§Œ
                ip = addrs[netifaces.AF_INET][0]['addr']
                interfaces.append((iface, ip))
        return interfaces
    
    def apply_network_config(self):
        """ë„¤íŠ¸ì›Œí¬ ì„¤ì • ì ìš©"""
        print(f"\n{Colors.CYAN}ë„¤íŠ¸ì›Œí¬ ì„¤ì •ì„ ì ìš©í•©ë‹ˆë‹¤...{Colors.ENDC}")
        
        # Ubuntu/Debian êµ¬ë¶„
        if Path('/etc/netplan').exists():
            # Ubuntu (Netplan ì‚¬ìš©)
            self.apply_netplan_config()
        elif Path('/etc/dhcpcd.conf').exists():
            # Raspberry Pi OS / Debian (dhcpcd ì‚¬ìš©)
            self.apply_dhcpcd_config()
        else:
            print(f"{Colors.WARNING}ë„¤íŠ¸ì›Œí¬ ì„¤ì • ë°©ì‹ì„ ìë™ìœ¼ë¡œ ê°ì§€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.{Colors.ENDC}")
            print("ìˆ˜ë™ìœ¼ë¡œ ì„¤ì •í•´ì£¼ì„¸ìš”.")
    
    def apply_netplan_config(self):
        """Netplan ì„¤ì • ì ìš© (Ubuntu)"""
        netplan_config = f"""network:
  version: 2
  ethernets:
    {self.config['network_interface']}:
      addresses:
        - {self.config['server_ip']}/24
      routes:
        - to: default
          via: {'.'.join(self.config['server_ip'].split('.')[:3])}.1
      nameservers:
        addresses: [8.8.8.8, 8.8.4.4]
"""
        
        netplan_file = '/etc/netplan/99-pxe-server.yaml'
        
        try:
            # ì„¤ì • íŒŒì¼ ì‘ì„±
            temp_netplan = os.path.expanduser('~/netplan_config.yaml.tmp')
            with open(temp_netplan, 'w') as f:
                f.write(netplan_config)
            
            # sudoë¡œ ë³µì‚¬
            subprocess.run(['sudo', 'cp', temp_netplan, netplan_file], check=True)
            os.remove(temp_netplan)
            
            print(f"{Colors.GREEN}Netplan ì„¤ì • íŒŒì¼ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤: {netplan_file}{Colors.ENDC}")
            print("ì„¤ì •ì„ ì ìš©í•©ë‹ˆë‹¤...")
            
            # netplan apply
            result = subprocess.run(['sudo', 'netplan', 'apply'], 
                                  capture_output=True, text=True)
            
            if result.returncode == 0:
                print(f"{Colors.GREEN}âœ… ë„¤íŠ¸ì›Œí¬ ì„¤ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!{Colors.ENDC}")
                print(f"ìƒˆ IP ì£¼ì†Œ: {self.config['server_ip']}")
            else:
                print(f"{Colors.FAIL}âŒ ì„¤ì • ì ìš© ì‹¤íŒ¨: {result.stderr}{Colors.ENDC}")
                
        except Exception as e:
            print(f"{Colors.FAIL}âŒ ì˜¤ë¥˜ ë°œìƒ: {e}{Colors.ENDC}")
    
    def apply_dhcpcd_config(self):
        """dhcpcd ì„¤ì • ì ìš© (Debian/Raspberry Pi OS)"""
        dhcpcd_config = f"""
# PXE Server Configuration
interface {self.config['network_interface']}
static ip_address={self.config['server_ip']}/24
static routers={'.'.join(self.config['server_ip'].split('.')[:3])}.1
static domain_name_servers=8.8.8.8 8.8.4.4
"""
        
        try:
            # ê¸°ì¡´ ì„¤ì • ë°±ì—…
            subprocess.run(['sudo', 'cp', '/etc/dhcpcd.conf', '/etc/dhcpcd.conf.backup'], 
                         check=True)
            
            # ì„¤ì • ì¶”ê°€
            temp_dhcpcd = os.path.expanduser('~/dhcpcd_append.conf.tmp')
            with open(temp_dhcpcd, 'w') as f:
                f.write(dhcpcd_config)
            
            subprocess.run(['sudo', 'bash', '-c', 
                          f'cat {temp_dhcpcd} >> /etc/dhcpcd.conf'], 
                         check=True)
            os.remove(temp_dhcpcd)
            
            print(f"{Colors.GREEN}dhcpcd ì„¤ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.{Colors.ENDC}")
            print("ì„œë¹„ìŠ¤ë¥¼ ì¬ì‹œì‘í•©ë‹ˆë‹¤...")
            
            # dhcpcd ì¬ì‹œì‘
            subprocess.run(['sudo', 'systemctl', 'restart', 'dhcpcd'], check=True)
            
            print(f"{Colors.GREEN}âœ… ë„¤íŠ¸ì›Œí¬ ì„¤ì •ì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!{Colors.ENDC}")
            print(f"ìƒˆ IP ì£¼ì†Œ: {self.config['server_ip']}")
            
        except Exception as e:
            print(f"{Colors.FAIL}âŒ ì˜¤ë¥˜ ë°œìƒ: {e}{Colors.ENDC}")
    
    def generate_dnsmasq_config(self):
        """dnsmasq í†µí•© ì„¤ì • íŒŒì¼ ìë™ ìƒì„± - ë‹¨ì¼ íŒŒì¼ë¡œ í†µí•©"""
        network_base = '.'.join(self.config['server_ip'].split('.')[:3])
        
        # í†µí•©ëœ dnsmasq ì„¤ì • ìƒì„±
        unified_conf = f"""# Unified dnsmasq configuration - RPI PXE Manager
port=0

# PXE Boot Configuration
interface={self.config['network_interface']}
bind-interfaces

# DHCP Range for dynamic allocation (avoid fixed IPs)
# Fixed IPs: 100-199 reserved for manual assignment (100 devices)
# Dynamic range: 200-250 for DHCP
dhcp-range={network_base}.200,{network_base}.250,255.255.255.0,1h

# Set this server as authoritative DHCP
dhcp-authoritative

# Faster DHCP response (beat router)
dhcp-rapid-commit

# DHCP Options
dhcp-option=3,{network_base}.1
dhcp-option=6,8.8.8.8,8.8.4.4
dhcp-option=66,{self.config['server_ip']}
dhcp-option=150,{self.config['server_ip']}

# Tag for all PXE clients
dhcp-match=set:pxeclient,60,PXEClient*

# Tag for Raspberry Pi
dhcp-vendorclass=set:rpi,PXEClient:Arch:00000:UNDI:002001

# PXE/TFTP - Respond to all PXE requests
dhcp-boot=tag:pxeclient,bootcode.bin,rpi-server,{self.config['server_ip']}
dhcp-boot=tag:rpi,bootcode.bin,rpi-server,{self.config['server_ip']}
dhcp-boot=bootcode.bin,rpi-server,{self.config['server_ip']}

# Enable TFTP
enable-tftp
tftp-root={self.config['tftp_root']}
tftp-no-blocksize

# PXE Service
pxe-service=0,"Raspberry Pi Boot",bootcode.bin,{self.config['server_ip']}
pxe-prompt="Booting Raspberry Pi",1

# Logging
log-dhcp
log-queries

# Client Configurations
"""
        
        # ê¸°ì¡´ í´ë¼ì´ì–¸íŠ¸ ì„¤ì • ì¶”ê°€
        for client in self.config.get('clients', []):
            if client.get('mac') and client.get('ip'):
                unified_conf += f"""# Client: {client['serial']}
dhcp-host={client.get('mac', '')},{client.get('ip', '')},{client['serial']},infinite
dhcp-boot=tag:{client.get('mac', '')},{client['serial']}/bootcode.bin,rpi-server,{self.config['server_ip']}

"""
        
        try:
            # /etc/dnsmasq.d ë””ë ‰í† ë¦¬ ìƒì„± (ì—†ëŠ” ê²½ìš°)
            subprocess.run(['sudo', 'mkdir', '-p', '/etc/dnsmasq.d'], 
                         stderr=subprocess.DEVNULL, check=False)
            
            # ì„ì‹œ íŒŒì¼ì— ì‘ì„± í›„ /etc/dnsmasq.confë¡œ ë³µì‚¬
            temp_conf_file = os.path.expanduser('~/dnsmasq.conf.tmp')
            with open(temp_conf_file, 'w') as f:
                f.write(unified_conf)
            
            # ê¸°ì¡´ dnsmasq.conf ë°±ì—…
            subprocess.run(['sudo', 'cp', '/etc/dnsmasq.conf', '/etc/dnsmasq.conf.backup'], 
                         stderr=subprocess.DEVNULL, check=False)
            
            # ìƒˆ ì„¤ì • íŒŒì¼ ë³µì‚¬
            subprocess.run(['sudo', 'cp', temp_conf_file, '/etc/dnsmasq.conf'], 
                         check=True)
            
            # ì„ì‹œ íŒŒì¼ ì‚­ì œ
            os.remove(temp_conf_file)
            
            # ê¸°ì¡´ ê°œë³„ ì„¤ì • íŒŒì¼ë“¤ ì •ë¦¬
            subprocess.run(['sudo', 'bash', '-c', 'rm -f /etc/dnsmasq.d/client-*.conf'], 
                         stderr=subprocess.DEVNULL)
            subprocess.run(['sudo', 'bash', '-c', 'rm -f /etc/dnsmasq.d/pxe-*.conf'], 
                         stderr=subprocess.DEVNULL)
            
            print(f"  âœ“ dnsmasq í†µí•© ì„¤ì • ìƒì„± ì™„ë£Œ")
            
            # dnsmasq ì¬ì‹œì‘
            subprocess.run(['sudo', 'systemctl', 'restart', 'dnsmasq'], 
                         stderr=subprocess.DEVNULL, check=False)
            
            print(f"  âœ“ dnsmasq ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì™„ë£Œ")
            
        except Exception as e:
            print(f"  âš ï¸  ì„¤ì • íŒŒì¼ ìƒì„± ì‹¤íŒ¨: {e}")
            print(f"     ìˆ˜ë™ìœ¼ë¡œ ~/dnsmasq.conf.tmpë¥¼ /etc/dnsmasq.confë¡œ ë³µì‚¬í•˜ì„¸ìš”")
    
    def initial_setup_wizard(self):
        """ì´ˆê¸° ì„¤ì • ë§ˆë²•ì‚¬ - ì›í´ë¦­ ìë™ ì„¤ì •"""
        self.print_header()
        print(f"{Colors.BOLD}{Colors.GREEN}ğŸš€ ì›í´ë¦­ PXE ë¶€íŒ… ì„¤ì • ë§ˆë²•ì‚¬{Colors.ENDC}\n")
        print(f"{Colors.CYAN}ëª¨ë“  ì„¤ì •ì„ ìë™ìœ¼ë¡œ êµ¬ì„±í•©ë‹ˆë‹¤!{Colors.ENDC}\n")
        
        confirm = input("ìë™ ì„¤ì •ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Y/n): ").lower()
        if confirm == 'n':
            return

        # í•„ìˆ˜ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ í™•ì¸ ë° ì„¤ì¹˜
        print(f"\n{Colors.CYAN}ğŸ“¦ í•„ìˆ˜ íŒ¨í‚¤ì§€ í™•ì¸ ì¤‘...{Colors.ENDC}")
        required_packages = ['dnsmasq', 'nfs-kernel-server']
        missing_packages = []

        for pkg in required_packages:
            result = subprocess.run(['dpkg', '-l', pkg], capture_output=True)
            if result.returncode != 0:
                missing_packages.append(pkg)
                print(f"  âœ— {pkg} ë¯¸ì„¤ì¹˜")
            else:
                print(f"  âœ“ {pkg} ì„¤ì¹˜ë¨")

        if missing_packages:
            print(f"\n{Colors.WARNING}âš ï¸  í•„ìˆ˜ íŒ¨í‚¤ì§€ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤!{Colors.ENDC}")
            print(f"{Colors.YELLOW}ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ì„¤ì¹˜í•˜ì„¸ìš”:{Colors.ENDC}")
            print(f"  sudo apt update && sudo apt install -y {' '.join(missing_packages)}\n")

            install_now = input(f"ì§€ê¸ˆ ìë™ìœ¼ë¡œ ì„¤ì¹˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Y/n): ").lower()
            if install_now != 'n':
                try:
                    print(f"\n{Colors.CYAN}ğŸ“¦ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘...{Colors.ENDC}")
                    subprocess.run(['sudo', 'apt', 'update'], check=True)
                    subprocess.run(['sudo', 'apt', 'install', '-y'] + missing_packages, check=True)
                    print(f"{Colors.GREEN}  âœ“ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ!{Colors.ENDC}\n")
                except Exception as e:
                    print(f"{Colors.FAIL}  âœ— ì„¤ì¹˜ ì‹¤íŒ¨: {e}{Colors.ENDC}")
                    print(f"  ìˆ˜ë™ìœ¼ë¡œ ì„¤ì¹˜ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.")
                    return
            else:
                print(f"\n{Colors.WARNING}íŒ¨í‚¤ì§€ ì„¤ì¹˜ í›„ ë‹¤ì‹œ ì‹¤í–‰í•˜ì„¸ìš”.{Colors.ENDC}")
                return

        print(f"\n{Colors.CYAN}ğŸ” ë„¤íŠ¸ì›Œí¬ í™˜ê²½ ìë™ ê°ì§€ ì¤‘...{Colors.ENDC}")
        
        # ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ ìë™ ê°ì§€ ë° ì„¤ì •
        interfaces = self.get_network_interfaces()
        if interfaces:
            # ìœ ì„  ì¸í„°í˜ì´ìŠ¤ ìš°ì„  ì„ íƒ (enpë¡œ ì‹œì‘í•˜ëŠ” ê²ƒ)
            selected_iface = None
            for iface, ip in interfaces:
                if iface.startswith('enp') or iface.startswith('eth'):
                    selected_iface = (iface, ip)
                    break
            
            if not selected_iface:
                selected_iface = interfaces[0]
            
            self.config['network_interface'] = selected_iface[0]
            detected_ip = selected_iface[1]
            print(f"  âœ“ ì¸í„°í˜ì´ìŠ¤: {selected_iface[0]} (IP: {detected_ip})")
            
            # IP ëŒ€ì—­ ìë™ ì„¤ì • - ì„œë²„ëŠ” í•­ìƒ .10 ì‚¬ìš©
            ip_parts = detected_ip.split('.')
            network_base = '.'.join(ip_parts[:3])
            
            # ì„œë²„ IPë¥¼ .10ìœ¼ë¡œ ê³ ì • (ê³µìœ ê¸°ì™€ ì¶©ëŒ ë°©ì§€)
            self.config['server_ip'] = f"{network_base}.10"
            # í´ë¼ì´ì–¸íŠ¸ë§Œ ì‚¬ìš©í•  ê³ ì • IP ë²”ìœ„ (ë™ì  í• ë‹¹ ì—†ìŒ)
            self.config['dhcp_range_start'] = ""  # ë™ì  DHCP ì‚¬ìš© ì•ˆ í•¨
            self.config['dhcp_range_end'] = ""  # ë™ì  DHCP ì‚¬ìš© ì•ˆ í•¨
            print(f"  âœ“ ì„œë²„ IP: {self.config['server_ip']}")
            print(f"  âœ“ DHCP ë²”ìœ„: ê³ ì • IPë§Œ ì‚¬ìš© (100-199 ë²”ìœ„)")
        else:
            print(f"{Colors.WARNING}  ! ë„¤íŠ¸ì›Œí¬ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.{Colors.ENDC}")
            self.config['network_interface'] = 'enp0s31f6'  # ê¸°ë³¸ê°’
            self.config['server_ip'] = '192.168.0.10'
            network_base = '192.168.0'  # ê¸°ë³¸ê°’ ì„¤ì •
        
        # Netplan ì„¤ì • (ê³ ì • IP)
        print(f"\n{Colors.CYAN}ğŸ”§ ì„œë²„ ë„¤íŠ¸ì›Œí¬ ê³ ì • IP ì„¤ì •...{Colors.ENDC}")
        gateway_ip = f"{network_base}.1"
        
        netplan_config = f"""# Let NetworkManager manage all devices on this system
network:
  version: 2
  renderer: NetworkManager
  ethernets:
    {self.config['network_interface']}:
      dhcp4: no
      dhcp6: no
      addresses:
      - {self.config['server_ip']}/24
      gateway4: {gateway_ip}
      nameservers:
        addresses: [8.8.8.8, 1.1.1.1]
"""
        
        # Netplan ì„¤ì • íŒŒì¼ ì‘ì„±
        try:
            temp_netplan_file = os.path.expanduser('~/01-network-manager-all.yaml.tmp')
            with open(temp_netplan_file, 'w') as f:
                f.write(netplan_config)
            
            # ë°±ì—… ìƒì„±
            subprocess.run(['sudo', 'cp', '/etc/netplan/01-network-manager-all.yaml', 
                          '/etc/netplan/01-network-manager-all.yaml.backup'], 
                          stderr=subprocess.DEVNULL)
            
            # ìƒˆ ì„¤ì • ì ìš©
            subprocess.run(['sudo', 'cp', temp_netplan_file, 
                          '/etc/netplan/01-network-manager-all.yaml'], check=True)
            
            # ì„ì‹œ íŒŒì¼ ì‚­ì œ
            os.remove(temp_netplan_file)
            
            print(f"  âœ“ Netplan ì„¤ì • ì™„ë£Œ")
            print(f"    - ì¸í„°í˜ì´ìŠ¤: {self.config['network_interface']}")
            print(f"    - ê³ ì • IP: {self.config['server_ip']}")
            print(f"    - ê²Œì´íŠ¸ì›¨ì´: {gateway_ip}")
            
            # Netplan ì ìš© ì˜µì…˜
            apply_now = input(f"\n  {Colors.YELLOW}ì§€ê¸ˆ ë„¤íŠ¸ì›Œí¬ ì„¤ì •ì„ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (y/N): {Colors.ENDC}").lower()
            if apply_now == 'y':
                print(f"  {Colors.WARNING}ë„¤íŠ¸ì›Œí¬ê°€ ì ì‹œ ëŠê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤...{Colors.ENDC}")
                subprocess.run(['sudo', 'netplan', 'apply'], check=True)
                print(f"  âœ“ ë„¤íŠ¸ì›Œí¬ ì„¤ì • ì ìš© ì™„ë£Œ")
            else:
                print(f"  â„¹ï¸  ë‚˜ì¤‘ì— ìˆ˜ë™ìœ¼ë¡œ ì ìš©í•˜ë ¤ë©´: {Colors.YELLOW}sudo netplan apply{Colors.ENDC}")
            
        except Exception as e:
            print(f"  âš ï¸  Netplan ì„¤ì • ì‹¤íŒ¨: {e}")
            print(f"  ìˆ˜ë™ìœ¼ë¡œ /etc/netplan/01-network-manager-all.yaml íŒŒì¼ì„ ìˆ˜ì •í•˜ì„¸ìš”.")
        
        
        # DHCP ì¶©ëŒ ìë™ ê²€ì‚¬ ë° í•´ê²°
        print(f"\n{Colors.CYAN}ğŸ” DHCP ì¶©ëŒ ê²€ì‚¬ ì¤‘...{Colors.ENDC}")
        network_base = '.'.join(self.config['server_ip'].split('.')[:3])
        gateway_ip = f"{network_base}.1"
        
        # ê³µìœ ê¸° ì¡´ì¬ í™•ì¸ (pingìœ¼ë¡œ ë” í™•ì‹¤í•˜ê²Œ)
        try:
            ping_result = subprocess.run(['ping', '-c', '1', '-W', '1', gateway_ip], 
                                       capture_output=True, text=True)
            if ping_result.returncode == 0:
                print(f"  âœ“ ê³µìœ ê¸°({gateway_ip}) ê°ì§€ë¨")
                print(f"  âœ“ ì¼ë°˜ DHCP ëª¨ë“œ ì‚¬ìš© (ê³ ì • IP í• ë‹¹)")
                self.config['proxy_dhcp_mode'] = False
                # ê³µìœ ê¸°ê°€ ìˆì–´ë„ ìš°ë¦¬ê°€ íŠ¹ì • MACì—ë§Œ ì‘ë‹µí•˜ë„ë¡ ì„¤ì •
            else:
                print(f"  âš ï¸  ê³µìœ ê¸° ì—†ìŒ - ë…ë¦½ DHCP ì„œë²„ë¡œ ë™ì‘")
                self.config['proxy_dhcp_mode'] = False
        except:
            self.config['proxy_dhcp_mode'] = False
        
        # ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
        print(f"\n{Colors.CYAN}ğŸ“ ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •...{Colors.ENDC}")
        
        # NFS ë° TFTP ë””ë ‰í† ë¦¬ ìƒì„±
        self.config['nfs_root'] = '/media/rpi-client'
        self.config['tftp_root'] = '/tftpboot'
        
        for path in [self.config['nfs_root'], self.config['tftp_root']]:
            if not os.path.exists(path):
                try:
                    subprocess.run(['sudo', 'mkdir', '-p', path], check=True)
                    print(f"  âœ“ {path} ë””ë ‰í† ë¦¬ ìƒì„±ë¨")
                except:
                    print(f"  âš ï¸  {path} ìƒì„± ì‹¤íŒ¨ (ê¶Œí•œ í•„ìš”)")
        
        # /media/polygom3d/rpi-client ê¶Œí•œ ì„¤ì • (ëª¨ë‘ì—ê²Œ ì½ê¸°/ì“°ê¸°/ì‹¤í–‰ ê¶Œí•œ)
        try:
            subprocess.run(['sudo', 'chmod', '777', self.config['nfs_root']], check=True)
            print(f"  âœ“ {self.config['nfs_root']} ê¶Œí•œ ì„¤ì • ì™„ë£Œ (777)")
            
            # ì†Œìœ ìë„ ë³€ê²½ (ì„ íƒì )
            current_user = os.environ.get('SUDO_USER', os.environ.get('USER', 'rpi-server'))
            subprocess.run(['sudo', 'chown', f'{current_user}:{current_user}', self.config['nfs_root']], 
                         stderr=subprocess.DEVNULL, check=False)
            print(f"  âœ“ {self.config['nfs_root']} ì†Œìœ ì ë³€ê²½ ì™„ë£Œ ({current_user})")
        except Exception as e:
            print(f"  âš ï¸  ê¶Œí•œ ì„¤ì • ì‹¤íŒ¨: {e}")
        
        # /tftpboot ê¶Œí•œ ì„¤ì •
        try:
            subprocess.run(['sudo', 'chmod', '755', self.config['tftp_root']], check=True)
            print(f"  âœ“ {self.config['tftp_root']} ê¶Œí•œ ì„¤ì • ì™„ë£Œ (755)")
        except:
            pass
        
        # ì„œë¹„ìŠ¤ ì¶©ëŒ ìë™ í•´ê²°
        print(f"\n{Colors.CYAN}ğŸ”§ ì„œë¹„ìŠ¤ ì¶©ëŒ ìë™ í•´ê²° ì¤‘...{Colors.ENDC}")
        
        # tftpd-hpa ì¤‘ì§€ (dnsmasqê°€ TFTP ì œê³µ)
        try:
            subprocess.run(['sudo', 'systemctl', 'stop', 'tftpd-hpa'], 
                         stderr=subprocess.DEVNULL, check=False)
            subprocess.run(['sudo', 'systemctl', 'disable', 'tftpd-hpa'], 
                         stderr=subprocess.DEVNULL, check=False)
            print(f"  âœ“ tftpd-hpa ì„œë¹„ìŠ¤ ë¹„í™œì„±í™” (dnsmasq í†µí•© ì‚¬ìš©)")
        except:
            pass
        
        # ì„¤ì • ì €ì¥
        self.save_config()
        
        # dnsmasq ì„¤ì • ìë™ ìƒì„±
        print(f"\n{Colors.CYAN}ğŸ“ PXE ë¶€íŒ… ì„¤ì • ìƒì„± ì¤‘...{Colors.ENDC}")
        self.generate_dnsmasq_config()
        
        # ì„œë¹„ìŠ¤ ìë™ ì‹œì‘
        print(f"\n{Colors.CYAN}ğŸš€ ì„œë¹„ìŠ¤ ìë™ ì‹œì‘ ì¤‘...{Colors.ENDC}")
        services = ['nfs-kernel-server', 'dnsmasq']
        for service in services:
            try:
                subprocess.run(['sudo', 'systemctl', 'restart', service], 
                             stderr=subprocess.DEVNULL, check=False)
                
                # ìƒíƒœ í™•ì¸
                result = subprocess.run(['systemctl', 'is-active', service], 
                                      capture_output=True, text=True)
                if result.stdout.strip() == 'active':
                    print(f"  âœ“ {service} ì‹œì‘ë¨")
                else:
                    print(f"  âš ï¸  {service} ì‹œì‘ ì‹¤íŒ¨ (ìˆ˜ë™ ì‹œì‘ í•„ìš”)")
            except:
                print(f"  âš ï¸  {service} ì‹œì‘ ì‹¤íŒ¨ (sudo ê¶Œí•œ í•„ìš”)")
        
        print(f"\n{Colors.GREEN}{'='*50}{Colors.ENDC}")
        print(f"{Colors.GREEN}âœ… ì›í´ë¦­ ì„¤ì • ì™„ë£Œ!{Colors.ENDC}")
        print(f"{Colors.GREEN}{'='*50}{Colors.ENDC}")
        print(f"\n{Colors.BOLD}í˜„ì¬ ì„¤ì •:{Colors.ENDC}")
        print(f"  ì„œë²„ IP: {self.config['server_ip']}")
        print(f"  DHCP ë²”ìœ„: {self.config['dhcp_range_start']} - {self.config['dhcp_range_end']}")
        print(f"  ProxyDHCP: {'í™œì„±í™”' if self.config.get('proxy_dhcp_mode', False) else 'ë¹„í™œì„±í™”'}")
        print(f"\n{Colors.BOLD}ë‹¤ìŒ ë‹¨ê³„:{Colors.ENDC}")
        print(f"  1. í´ë¼ì´ì–¸íŠ¸ ê´€ë¦¬ â†’ ìƒˆ í´ë¼ì´ì–¸íŠ¸ ì¶”ê°€")
        print(f"  2. SD ì¹´ë“œì—ì„œ ì‹œìŠ¤í…œ ë³µì‚¬")
        print(f"  3. ë¼ì¦ˆë² ë¦¬íŒŒì´ PXE ë¶€íŒ…!")
        
        print(f"\n{Colors.WARNING}ë¬¸ì œ ë°œìƒ ì‹œ:{Colors.ENDC}")
        print(f"  - ì„œë²„ ì„¤ì • â†’ DHCP ì¶©ëŒ ê²€ì‚¬")
        print(f"  - ì„œë¹„ìŠ¤ ê´€ë¦¬ â†’ dnsmasq ì¬ì‹œì‘")
        
        # ìˆ˜ë™ìœ¼ë¡œ ì„œë¹„ìŠ¤ ì‹œì‘ ëª…ë ¹ì–´ ì œê³µ
        print(f"\n{Colors.CYAN}ìˆ˜ë™ ì„œë¹„ìŠ¤ ì‹œì‘ ëª…ë ¹ì–´:{Colors.ENDC}")
        print(f"  sudo systemctl restart dnsmasq")
        print(f"  sudo systemctl restart nfs-kernel-server")
        
        input(f"\n{Colors.CYAN}Enterë¥¼ ëˆŒëŸ¬ ê³„ì†...{Colors.ENDC}")
    
    def run(self):
        """ë©”ì¸ ë£¨í”„"""
        try:
            while self.running:
                self.print_header()
                self.print_menu()
                
                choice = input(f"{Colors.CYAN}ì„ íƒ: {Colors.ENDC}")
                
                if choice == '1':
                    self.show_system_status()
                elif choice == '2':
                    self.manage_clients()
                elif choice == '3':
                    self.server_settings()
                elif choice == '4':
                    self.manage_services()
                elif choice == '5':
                    self.view_logs()
                elif choice == '6':
                    self.initial_setup_wizard()
                elif choice == '0':
                    self.running = False
                    print(f"\n{Colors.GREEN}í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤. ì•ˆë…•íˆ ê°€ì„¸ìš”!{Colors.ENDC}")
                else:
                    print(f"{Colors.WARNING}ì˜ëª»ëœ ì„ íƒì…ë‹ˆë‹¤.{Colors.ENDC}")
                    time.sleep(1)
        except KeyboardInterrupt:
            print(f"\n\n{Colors.WARNING}í”„ë¡œê·¸ë¨ì´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.{Colors.ENDC}")
            sys.exit(0)

def main():
    # Root ê¶Œí•œ í™•ì¸
    if os.geteuid() != 0:
        print(f"{Colors.WARNING}ì´ í”„ë¡œê·¸ë¨ì€ root ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.{Colors.ENDC}")
        print(f"ë‹¤ì‹œ ì‹¤í–‰í•©ë‹ˆë‹¤...")
        os.execvp('sudo', ['sudo', sys.executable] + sys.argv)
    
    manager = RPIPXEManager()
    manager.run()

if __name__ == "__main__":
    main()